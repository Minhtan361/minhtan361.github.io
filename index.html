<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chấm Công Thai Thae - minhtan361</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
    /* Nâng cấp giao diện hiện đại */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
        --primary-color: #00695c;
        --secondary-color: #3949ab;
        --success-color: #43a047;
        --danger-color: #e53935;
        --warning-color: #fbc02d;
        --bg-body: #e3e5e9;
        --card-shadow: 0 8px 20px rgba(0,0,0,0.08);
        --radius: 16px;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-body);
        color: #333;
    }

    /* Navbar */
    .navbar {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .navbar-brand {
        font-weight: 700;
        font-size: 1.2rem;
        color: #fff !important;
    }
    .navbar .btn {
        border-radius: 50px;
        font-weight: 600;
    }

    /* Card */
    .card {
        border: none;
        border-radius: var(--radius);
        box-shadow: var(--card-shadow);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.12);
    }
    .card-header {
        font-weight: 600;
        border-radius: var(--radius) var(--radius) 0 0 !important;
    }

    /* Clock */
    .clock-display {
        font-size: 3rem;
        font-weight: 700;
        color: var(--secondary-color);
    }

    /* Buttons */
    .btn {
        border-radius: 12px;
        font-weight: 600;
        padding: 0.6rem 1rem;
        transition: all 0.2s ease-in-out;
    }
    .btn-primary {
        background: var(--primary-color);
        border: none;
    }
    .btn-primary:hover {
        background: #004d40;
    }
    .btn-success:hover { background: #2e7d32; }
    .btn-danger:hover { background: #c62828; }
    .btn-outline-secondary:hover {
        background: #eceff1;
    }

    /* Tables */
    .table {
        border-radius: var(--radius);
        overflow: hidden;
    }
    .table thead {
        background-color: var(--secondary-color);
        color: #fff;
        font-weight: 600;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #fafafa;
    }
    .table-hover tbody tr:hover {
        background-color: #f1f1f1;
    }

    /* Payslip */
    .payslip {
        border-radius: var(--radius);
        box-shadow: var(--card-shadow);
        padding: 25px;
        background: #fff;
    }
    .payslip h4, .payslip h5 {
        color: var(--primary-color);
        font-weight: 700;
    }
    .summary-row {
        background: #e8f5e9;
        font-weight: 700;
    }

    /* Tabs */
    .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
        font-weight: 600;
    }
    .nav-tabs .nav-link.active {
        background-color: var(--primary-color);
        color: #fff;
    }

    /* Inputs */
    .form-control, .form-select {
        border-radius: 10px;
        border: 1px solid #ddd;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.2rem rgba(63,81,181,0.25);
    }

    /* Custom styles for new features */
    .attendance-history-panel {
        display: none;
    }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-business-time me-2"></i>Chấm Công Thai Thae - minhtan361</a>
            <button class="btn btn-outline-light" id="adminToggle"><i class="fas fa-user-shield me-1"></i>Chế độ Admin</button>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="loading" id="loadingIndicator"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Đang tải dữ liệu...</p></div>

        <div class="row">
            <div class="col-md-5"> 
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Thời gian hiện tại</h5>
                        <div class="clock-display" id="currentTime">00:00:00</div>
                        <div id="currentDate" class="text-secondary fw-light"></div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white"><h5 class="mb-0"><i class="fas fa-fingerprint me-2"></i>Khu vực Chấm công</h5></div>
                    <div class="card-body">
                        <div id="loginArea">
                            <h6 class="mb-3 text-secondary">Đăng nhập để Chấm công</h6>
                            <div class="row g-3 align-items-end">
                                <div class="col-12"><label class="small">Username</label><input class="form-control" id="loginUsername" placeholder="ví dụ: quynhanh, phuoclong ,..."></div>
                                <div class="col-12"><label class="small">Mật khẩu</label><input type="password" class="form-control" id="loginPassword" placeholder="mật khẩu: thaithae"></div>
                                <div class="col-12 d-flex gap-2"><button class="btn btn-primary w-100" id="loginBtn">Đăng nhập</button><button class="btn btn-outline-secondary w-100" id="loginByIdBtn">Đăng nhập bằng ID</button></div>
                            </div>
                            <div class="mt-3" id="loginMessage"></div>
                        </div>

                        <div id="clockingArea" class="d-none text-center">
                            <h4 class="mb-3">Xin chào, <strong id="loggedName" class="text-primary"></strong> (<span id="loggedPosition"></span>)</h4>
                            <p class="text-danger small">Ca làm mặc định: <strong id="loggedShift"></strong></p>

                            <div class="mb-3 text-start">
                                <label for="shiftSelect" class="form-label small fw-bold"><i class="fas fa-calendar-check me-1"></i>1. Chọn ca làm hôm nay:</label>
                                <select class="form-select" id="shiftSelect"></select>
                            </div>
                            <div class="mb-3 text-start">
                                <label for="lateReason" class="form-label small fw-bold"><i class="fas fa-pencil-alt me-1"></i>2. Xin phép đi muộn (Ghi trước khi chấm công vào và giới hạn 2 lần/tuần):</label>
                                <textarea class="form-control" id="lateReason" rows="1" placeholder="Em xin đi muộn 30p do bận việc..."></textarea>
                                <small class="text-muted">Ghi chú này sẽ loại bỏ phạt đi trễ 10.000 VND nếu bạn chấm công muộn. <span id="lateNotesRemaining"></span></small>
                                <button class="btn btn-warning btn-sm w-100 mt-2" id="submitLateRequestBtn"><i class="fas fa-paper-plane me-2"></i>Gửi yêu cầu</button> 
                            </div>

                            <div class="clocking-buttons d-flex gap-3 justify-content-center">
                                <button class="btn btn-success btn-lg w-50" id="checkInBtn"><i class="fas fa-sign-in-alt me-2"></i>Vào</button>
                                <button class="btn btn-danger btn-lg w-50" id="checkOutBtn"><i class="fas fa-sign-out-alt me-2"></i>Ra</button>
                            </div>
                            <div class="mt-3"><button class="btn btn-secondary btn-sm" id="logoutBtn">Thoát phiên</button></div>
                            <p class="mt-2 small text-muted">Phiên đăng nhập còn hiệu lực 361</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-7" id="adminDashboardPanel" style="display:none;">
                <div class="card">
                    <div class="card-header bg-secondary-color text-white" style="background-color: var(--secondary-color) !important;">
                        <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Bảng Điều Khiển Quản Trị</h5>
                    </div>
                    <div class="card-body">
                        <div class="admin-verification-area mb-4" id="adminVerificationArea">
                            <h6 class="mb-3 text-primary"><i class="fas fa-lock me-2"></i>Xác minh Admin</h6>
                            <div class="input-group">
                                <input type="password" class="form-control" id="adminCode" placeholder="Nhập mã khóa admin">
                                <button class="btn btn-primary" id="verifyAdmin"><i class="fas fa-check me-1"></i>Xác nhận</button>
                            </div>
                        </div>

                        <div class="admin-tabs d-none" id="adminFeatures">
                            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                                <li class="nav-item"><button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-content" type="button"><i class="fas fa-table me-1"></i>1. Dữ liệu & Tính lương</button></li>
                                <li class="nav-item"><button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-content" type="button"><i class="fas fa-cogs me-1"></i>2. Cài đặt & Nhân viên</button></li>
                            </ul>
                            <div class="tab-content pt-3" id="adminTabsContent">
                                
                                <div class="tab-pane fade show active" id="data-content" role="tabpanel">
                                    <h6 class="text-primary mb-3"><i class="fas fa-filter me-1"></i>Bộ lọc Dữ liệu</h6>
                                    <div class="row mb-3 g-3 align-items-end">
                                        <div class="col-md-2"><label class="small">Từ ngày</label><input type="date" class="form-control" id="startDate"></div>
                                        <div class="col-md-2"><label class="small">Đến ngày</label><input type="date" class="form-control" id="endDate"></div>
                                        <div class="col-md-3"><label class="small">Chức vụ</label><select class="form-select" id="exportPosition"><option value="all">Tất cả</option></select></div>
                                        <div class="col-md-3"><label class="small">Nhân viên</label><select class="form-select" id="exportEmployee"><option value="all">Tất cả</option></select></div>
                                        <div class="col-md-2">
                                            <button class="btn btn-info w-100" id="applyFilterBtn"><i class="fas fa-filter me-2"></i>Áp dụng</button>
                                        </div>
                                    </div>
                                    <h5 class="mt-4 text-primary"><i class="fas fa-table me-2"></i>Dữ liệu Chấm công</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-sm small" id="attendanceTable"><thead><tr><th>Ngày</th><th>Nhân viên</th><th>Ca</th><th>Giờ vào</th><th>Giờ ra</th><th>Giờ làm</th><th>Trạng thái</th><th>Ghi chú/Xin phép</th></tr></thead><tbody></tbody></table>
                                    </div>
                                    <button class="btn btn-primary btn-sm w-100" id="exportBtn"><i class="fas fa-file-excel me-2"></i>Xuất Excel Dữ liệu Chấm công</button>

                                    <div class="mt-4 text-center">
                                        <button class="btn btn-success btn-lg" id="computePayrollBtn"><i class="fas fa-calculator me-2"></i>TÍNH LƯƠNG</button>
                                        <button class="btn btn-primary btn-lg d-none" id="printPayrollBtn"><i class="fas fa-print me-2"></i>IN/XUẤT BẢNG LƯƠNG</button>
                                    </div>

                                    <div class="mt-4" id="payrollResultArea" style="display:none">
                                        <h5 class="text-success"><i class="fas fa-money-check-alt me-2"></i>Bảng lương chi tiết</h5>
                                        <div id="payrollResult"></div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="settings-content" role="tabpanel">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-users-cog me-1"></i>Quản lý nhân viên</h5>
                                    <p class="text-danger small">* Khi tạo nhân viên hệ thống tự tạo username và mật khẩu mặc định: <strong>thaithae</strong></p>

                                    <div class="row mb-3 g-2 align-items-end">
                                        <div class="col-md-3"><label class="small">Tên nhân viên</label><input type="text" class="form-control" id="employeeName" placeholder="Tên nhân viên"></div>
                                        <div class="col-md-3"><label class="small">Chức vụ</label><input type="text" class="form-control" id="employeePosition" placeholder="Chức vụ"></div>
                                        <div class="col-md-2"><label class="small">Lương cơ bản</label><input type="number" class="form-control" id="employeeBaseSalary" placeholder="Lương (VND)"></div>
                                        <div class="col-md-2"><label class="small">Ca mặc định</label>
                                            <select class="form-select" id="employeeShift">
                                                <option value="shift1">Ca 1</option><option value="shift2">Ca 2</option><option value="shift3">Ca 3</option>
                                                <option value="shift4">Ca 4</option><option value="shift5">Ca 5</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-success w-100" id="addEmployee"><i class="fas fa-user-plus"></i> Thêm</button>
                                        </div>
                                    </div>

                                    <div class="table-responsive mb-4">
                                        <table class="table table-striped table-hover small" id="employeesTable">
                                            <thead class="bg-light"><tr><th>ID</th><th>Tên</th><th>Username</th><th>Chức vụ</th><th>Ca mặc định</th><th>Lương cơ bản</th><th>Hành động</th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>

                                    <h5 class="mt-4 text-primary"><i class="fas fa-sliders-h me-1"></i>Cài đặt tính lương</h5>
                                    <div class="row mb-3 g-2">
                                        <div class="col-md-4"><label class="small">Lương theo giờ (VND)</label><input type="number" id="wagePerHour" class="form-control" placeholder="Lương theo giờ (VND)"></div>
                                        <div class="col-md-4"><label class="small">Thưởng mặc định (VND)</label><input type="number" id="defaultBonus" class="form-control" placeholder="Thưởng mặc định (VND)"></div>
                                        <div class="col-md-4"><label class="small">Phạt chung (VND)</label><input type="number" id="defaultPenalty" class="form-control" placeholder="Phạt chung (VND)"></div>
                                    </div>
                                    <div class="row mb-3 g-2">
                                        <div class="col-md-4"><label class="small">Phạt đi muộn (VND)</label><input type="number" id="latePenalty" class="form-control" placeholder="Phạt 10000"></div>
                                        <div class="col-md-4"><label class="small">Phạt sửa/quên công (VND)</label><input type="number" id="editPenalty" class="form-control" placeholder="Phạt 20000"></div>
                                        <div class="col-md-4"><label class="small">Phạt quên chấm ra (VND)</label><input type="number" id="forgotOutPenalty" class="form-control" placeholder="Phạt 20000"></div>
                                    </div>
                                    <div class="row mb-3 g-2">
                                        <div class="col-12"><label class="small">Minhtan config:</label><input type="text" class="form-control" id="wifiIpAddress" placeholder="Nhập địa chỉ IP công cộng của quán (ví dụ: 103.111.200.222)"></div>
                                    </div>

                                    <h5 class="mt-4 text-primary"><i class="fas fa-calendar-alt me-1"></i>Danh sách ngày lễ (Lương x2)</h5>
                                    <div class="row mb-3 g-2">
                                        <div class="col-md-8"><input type="text" id="holidayList" class="form-control" rows="1" placeholder="YYYY-MM-DD, cách nhau bằng dấu phẩy hoặc xuống dòng"></div>
                                        <div class="col-md-4 d-flex align-items-end"><button class="btn btn-primary w-100" id="saveSettings">Lưu Cài đặt Chung</button></div>
                                    </div>
                                    <p class="small text-muted" id="currentHolidays"></p>

                                    <h5 class="mt-4 text-primary"><i class="fas fa-tools me-1"></i>Thao tác bảo trì</h5>
                                    <div class="row mt-3 g-2">
                                        <div class="col-md-6"><button class="btn btn-danger w-100" id="clearDataBtn"><i class="fas fa-trash me-1"></i>Xóa dữ liệu chấm công</button></div>
                                        <div class="col-md-6"><button class="btn btn-secondary w-100" id="forceLogoutAll"><i class="fas fa-sign-out-alt me-1"></i>Đăng xuất tất cả phiên</button></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-7 attendance-history-panel" id="personalAttendancePanel">
                <div class="card">
                    <div class="card-header bg-secondary-color text-white" style="background-color: var(--secondary-color) !important;">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Lịch sử Chấm công của bạn</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm small" id="personalAttendanceTable">
                                <thead>
                                    <tr>
                                        <th>Ngày</th>
                                        <th>Ca</th>
                                        <th>Giờ vào</th>
                                        <th>Giờ ra</th>
                                        <th>Giờ làm</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="printExportModal" tabindex="-1" aria-labelledby="printExportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="printExportModalLabel">In / Xuất Bảng Lương</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="payslipContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="printAllPayslipsBtn"><i class="fas fa-print"></i> In tất cả Phiếu lương</button>
                    <button type="button" class="btn btn-success" id="exportPayslipExcelBtn"><i class="fas fa-file-excel"></i> Xuất Bảng lương Tổng hợp Excel</button>
                </div>
            </div>
        </div>
    </div>

<script>
VANTA.WAVES({
  el: "body", // Áp dụng lên thẻ body
  mouseControls: true,
  touchControls: true,
  minHeight: 200.00,
  minWidth: 200.00,
  scale: 1.00,
  scaleMobile: 1.00,
  // CẤU HÌNH TỪ NGƯỜI DÙNG:
  colors: [
    {
      color: '#5365FF',
      enabled: true,
    },
    {
      color: '#5864FF',
      enabled: true,
    },
    {
      color: '#322085',
      enabled: true,
    },
    {
      color: '#3B94FF',
      enabled: true,
    },
    {
      color: '#E1F0F5',
      enabled: false,
    },
  ],
  speed: 4,
  horizontalPressure: 2,
  verticalPressure: 10,
  waveFrequencyX: 2,
  waveFrequencyY: 10,
  waveAmplitude: 10,
  shadows: 10,
  highlights: 0,
  colorBrightness: 1.2,
  colorSaturation: -3,
  wireframe: false,
  colorBlending: 10,
  backgroundColor: '#003FFF',
  backgroundAlpha: 0,
  grainScale: 0,
  grainSparsity: 0,
  grainIntensity: 0,
  grainSpeed: 10,
  resolution: 1,
  yOffset: 0,
});
</script>

    <script>
    // Firebase config (giữ nguyên)
    const firebaseConfig = {
      apiKey: "AIzaSyD3LxaZzvFsbtzA4VRYjVWvIOdqgyNYO2o",
      authDomain: "quan-ly-cham-cong-105da.firebaseapp.com",
      projectId: "quan-ly-cham-cong-105da",
      storageBucket: "quan-ly-cham-cong-105da.firebasestorage.app",
      messagingSenderId: "226837876955",
      appId: "1:226837876955:web:883453c0b19b25098bbcfe",
      measurementId: "G-KLZTCZF14B"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // App state
    let employees = [];
    let attendance = [];
    let isAdmin = false;
    let payrollResults = {}; 
    let isEditingEmployee = {};
    let loggedInUser = null; 
    
    // UPDATED SETTINGS
    let settings = { wagePerHour: 0, defaultBonus:0, defaultPenalty:0, latePenalty:10000, editPenalty:20000, forgotOutPenalty:20000, holidays: [], wifiIpAddress: '' };
    
    // QUY TẮC GRACE PERIOD 5 PHÚT (Nghiêm ngặt)
    const GRACE_PERIOD_MS = 5 * 60 * 1000; // 5 phút
    const LATE_NOTE_LIMIT = 2; // Giới hạn số lần dùng ghi chú đi muộn mỗi tuần

    // Shift definitions
    const shifts = {
        shift1: { name: 'Ca 1', start: '10:30:00', end: '16:30:00', minutes: 360 }, // 6 hours
        shift2: { name: 'Ca 2', start: '09:00:00', end: '17:00:00', minutes: 480 }, // 8 hours
        shift3: { name: 'Ca 3', start: '17:00:00', end: '23:00:00', minutes: 360 }, // 6 hours
        shift4: { name: 'Ca 4', start: '09:00:00', end: '23:00:00', minutes: 840 }, // 14 hours
        shift5: { name: 'Ca 5', start: '10:30:00', end: '23:00:00', minutes: 750 }  // 12.5 hours
    };

    // DOM 
    const loadingIndicator = document.getElementById('loadingIndicator');
    const employeesTable = document.getElementById('employeesTable').querySelector('tbody');
    const exportEmployee = document.getElementById('exportEmployee');
    const exportPosition = document.getElementById('exportPosition'); 
    const adminDashboardPanel = document.getElementById('adminDashboardPanel'); 
    const adminVerificationArea = document.getElementById('adminVerificationArea');
    const adminFeatures = document.getElementById('adminFeatures');
    const attendanceTableBody = document.getElementById('attendanceTable').querySelector('tbody');
    const payrollResultArea = document.getElementById('payrollResultArea');
    const payrollResult = document.getElementById('payrollResult');
    const printPayrollBtn = document.getElementById('printPayrollBtn');
    const computePayrollBtn = document.getElementById('computePayrollBtn');
    const payslipContainer = document.getElementById('payslipContainer');
    const shiftSelect = document.getElementById('shiftSelect'); 
    const personalAttendancePanel = document.getElementById('personalAttendancePanel');
    const personalAttendanceTableBody = document.getElementById('personalAttendanceTable').querySelector('tbody');
    const lateReasonInput = document.getElementById('lateReason');
    const lateNotesRemainingSpan = document.getElementById('lateNotesRemaining');

    // Session handling
    const SESSION_KEY = 'thai_thae_session';
    const SESSION_DURATION_MS = 4 * 24 * 60 * 60 * 1000; // 4 days

    // Utility functions
    function showLoading(){ loadingIndicator.style.display='block' }
    function hideLoading(){ loadingIndicator.style.display='none' }
    function formatVND(amount){ return Number(amount).toLocaleString('vi-VN') + ' VND'; }
    function updateClock(){ const now = new Date(); document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN'); document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', {weekday:'long', year:'numeric', month:'long', day:'numeric'}); }
    setInterval(updateClock,1000); updateClock();

    function toUsername(name){
        if(!name) return '';
        let s = name.trim().toLowerCase();
        s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        s = s.replace(/[^a-z0-9]/g,'');
        return s;
    }

    // --- CHỨC NĂNG MỚI: KIỂM TRA IP WIFI ---
    async function getPublicIpAddress() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) {
                throw new Error('Không thể lấy địa chỉ IP.');
            }
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error("Lỗi lấy IP:", error);
            return null;
        }
    }

    async function isConnectedToAuthorizedWifi() {
        const publicIp = await getPublicIpAddress();
        if (!publicIp) {
            alert('Không ở quán ai cho chấm công hả. Kết nối wifi của quán đi.');
            return false;
        }

        const authorizedIps = settings.wifiIpAddress.split(',').map(ip => ip.trim());

        if (authorizedIps.includes(publicIp)) {
            return true;
        } else {
            alert(`Tới quán mới chấm công được !!! IP hiện tại : ${publicIp}`);
            return false;
        }
    }

    // --- CHỨC NĂNG MỚI: TẢI VÀ HIỂN THỊ LỊCH SỬ CÁ NHÂN ---
    let unsubscribePersonalAttendance = null;
    function loadPersonalAttendance(employeeId) {
        if (unsubscribePersonalAttendance) unsubscribePersonalAttendance();
        unsubscribePersonalAttendance = db.collection('attendance')
            .where('employeeId', '==', employeeId)
            .orderBy('date', 'desc')
            .onSnapshot(snap => {
                const history = [];
                snap.forEach(doc => history.push({id: doc.id, ...doc.data()}));
                populatePersonalAttendanceUI(history);
            });
    }

    function populatePersonalAttendanceUI(history) {
        personalAttendanceTableBody.innerHTML = '';
        if (history.length === 0) {
            personalAttendanceTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Bạn chưa có lịch sử chấm công nào.</td></tr>';
            return;
        }

        history.forEach(r => {
            const emp = employees.find(x => x.id === r.employeeId) || {};
            const finalShiftKey = r.shiftChosen || emp.shift || 'shift2'; 
            const empShift = shifts[finalShiftKey];

            let checkIn = r.checkIn || '---';
            let finalCheckOut = r.checkOut || '---';
            let hoursText = '0 giờ 0 phút';
            let status = '';

            if (r.checkIn) {
                let inDT = new Date(`${r.date}T${r.checkIn}`);
                let outDT = null;
                if (!r.checkOut) {
                    outDT = new Date(`${r.date}T23:00:00`);
                } else {
                    outDT = new Date(`${r.date}T${r.checkOut}`);
                }
                if (outDT <= inDT) outDT.setDate(outDT.getDate() + 1);
                const diff = Math.max(0, outDT - inDT);
                const hrs = Math.floor(diff / 3600000);
                const mins = Math.round((diff % 3600000) / 60000);
                hoursText = `${hrs} giờ ${mins} phút`;

                const shiftStart = new Date(`${r.date}T${empShift.start}`);
                const isAfterGracePeriod = inDT.getTime() > (shiftStart.getTime() + GRACE_PERIOD_MS);
                
                if (r.edited) {
                    status = 'Sửa công';
                } else if (!r.checkOut) {
                    status = 'Quên chấm ra';
                    finalCheckOut = '23:00:00 (Hệ thống)';
                } else if (r.lateReason) {
                    status = 'Đi muộn (Xin phép)';
                } else if (isAfterGracePeriod) {
                    status = 'Đi muộn (Bị phạt)';
                } else {
                    status = 'Đúng giờ';
                }
            } else {
                status = 'Vắng mặt';
            }

            const isHoliday = settings.holidays && settings.holidays.indexOf(r.date) >= 0;
            if (isHoliday) status += ' / Ngày lễ';

            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${new Date(r.date).toLocaleDateString('vi-VN')}</td>
                            <td>${empShift?.name||'N/A'}</td>
                            <td>${checkIn}</td>
                            <td>${finalCheckOut}</td>
                            <td>${hoursText}</td>
                            <td>${status}</td>`;
            personalAttendanceTableBody.appendChild(tr);
        });
    }

    
    async function checkWeeklyLateNotes(employeeId) {
        const today = new Date();
        const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)));
        firstDayOfWeek.setHours(0, 0, 0, 0);
        
        const q = await db.collection('attendance')
                          .where('employeeId', '==', employeeId)
                          .where('timestamp', '>=', firstDayOfWeek)
                          .get();
        
        let lateNotesUsed = 0;
        q.forEach(doc => {
            if (doc.data().lateReason) {
                lateNotesUsed++;
            }
        });
        
        const remaining = Math.max(0, LATE_NOTE_LIMIT - lateNotesUsed);
        
        if (remaining > 0) {
            lateReasonInput.disabled = false;
            lateNotesRemainingSpan.textContent = `(Còn lại: ${remaining} lượt)`;
        } else {
            lateReasonInput.disabled = true;
            lateReasonInput.value = '';
            lateNotesRemainingSpan.textContent = '(Đã hết lượt xin phép trong tuần)';
        }
    }
    
    // Load employees + attendance from Firestore
    let unsubscribeEmployees=null, unsubscribeAttendance=null;
    function loadEmployees(){ showLoading(); if(unsubscribeEmployees) unsubscribeEmployees(); unsubscribeEmployees = db.collection('employees').onSnapshot(snap=>{ employees=[]; snap.forEach(doc=> employees.push({id:doc.id, ...doc.data()})); populateEmployeesUI(); hideLoading(); tryRestoreSession(); },err=>{ console.error(err); hideLoading(); alert('Lỗi tải nhân viên'); }); }
    function loadAttendance(){ showLoading(); if(unsubscribeAttendance) unsubscribeAttendance(); unsubscribeAttendance = db.collection('attendance').orderBy('date','desc').onSnapshot(snap=>{ attendance=[]; snap.forEach(doc=> attendance.push({id:doc.id, ...doc.data()})); populateAttendanceTable(); hideLoading(); },err=>{ console.error(err); hideLoading(); alert('Lỗi tải chấm công'); }); }

    // Populate Employees UI (Đã thêm tính năng CHỈNH SỬA)
    function populateEmployeesUI(){
        employeesTable.innerHTML='';
        exportEmployee.innerHTML='';
        exportPosition.innerHTML=''; 
        
        let allEmpOpt = document.createElement('option'); allEmpOpt.value='all'; allEmpOpt.textContent='Tất cả nhân viên'; exportEmployee.appendChild(allEmpOpt);
        
        // NEW: Add 'Tất cả chức vụ' option and prepare for unique positions
        let allPosOpt = document.createElement('option'); allPosOpt.value='all'; allPosOpt.textContent='Tất cả chức vụ'; exportPosition.appendChild(allPosOpt);
        const uniquePositions = new Set();
        
        employees.forEach(e=>{
            const isEditing = isEditingEmployee[e.id];
            const shiftName = shifts[e.shift]?.name || e.shift || '';
            const tr = document.createElement('tr');
            tr.id = `emp-row-${e.id}`;

            // Tạo danh sách Option cho Shift (dùng chung cho cả Edit và Display nếu cần)
            const shiftOptions = Object.keys(shifts).map(key => 
                `<option value="${key}" ${e.shift === key ? 'selected' : ''}>${shifts[key].name}</option>`
            ).join('');
            
            if (isEditing) {
                 // Chế độ chỉnh sửa: hiển thị ô nhập liệu
                 tr.innerHTML = `
                    <td>${e.id}</td>
                    <td><input type="text" class="form-control form-control-sm" id="edit-name-${e.id}" value="${e.name}"></td>
                    <td>${e.username||''}</td>
                    <td><input type="text" class="form-control form-control-sm" id="edit-position-${e.id}" value="${e.position||''}"></td>
                    <td>
                        <select class="form-select form-select-sm" id="edit-shift-${e.id}">
                            ${shiftOptions}
                        </select>
                    </td>
                    <td><input type="number" class="form-control form-control-sm" id="edit-salary-${e.id}" value="${e.baseSalary||0}"></td>
                    <td class="d-flex gap-1">
                        <button class="btn btn-sm btn-success btn-save" data-id="${e.id}"><i class="fas fa-save"></i> Lưu</button>
                        <button class="btn btn-sm btn-secondary btn-cancel" data-id="${e.id}"><i class="fas fa-times"></i> Hủy</button>
                    </td>`;
            } else {
                 // Chế độ hiển thị: hiển thị văn bản và nút Sửa/Xóa
                 tr.innerHTML = `
                    <td>${e.id}</td>
                    <td>${e.name}</td>
                    <td>${e.username||''}</td>
                    <td>${e.position||''}</td>
                    <td>${shiftName}</td>
                    <td>${formatVND(e.baseSalary||0)}</td>
                    <td class="d-flex gap-1">
                        <button class="btn btn-sm btn-info btn-edit" data-id="${e.id}"><i class="fas fa-edit"></i> Sửa</button>
                        <button class="btn btn-sm btn-danger btn-delete" data-id="${e.id}"><i class="fas fa-trash"></i> Xóa</button>
                    </td>`;
            }

            employeesTable.appendChild(tr);

            const opt = document.createElement('option'); opt.value = e.id; opt.textContent = e.name; exportEmployee.appendChild(opt);
            
            // NEW: Add position to set
            if (e.position && e.position.trim()) {
                uniquePositions.add(e.position.trim());
            }
        });
        
        // NEW: Populate the exportPosition select field
        uniquePositions.forEach(pos => {
            const opt = document.createElement('option');
            opt.value = pos;
            opt.textContent = pos;
            exportPosition.appendChild(opt);
        });

        // Add event listeners for new buttons
        document.querySelectorAll('.btn-delete').forEach(btn=> btn.addEventListener('click', deleteEmployee));
        document.querySelectorAll('.btn-edit').forEach(btn=> btn.addEventListener('click', editEmployee));
        document.querySelectorAll('.btn-save').forEach(btn=> btn.addEventListener('click', saveEmployee));
        document.querySelectorAll('.btn-cancel').forEach(btn=> btn.addEventListener('click', cancelEdit));
    }
    
    // Logic chỉnh sửa nhân viên 
    function deleteEmployee(event){
        if(!isAdmin){alert('Bạn cần quyền admin');return;} 
        const id=event.currentTarget.getAttribute('data-id'); 
        if(confirm('Xóa nhân viên? Hành động này không thể hoàn tác.')) db.collection('employees').doc(id).delete();
    }

    function editEmployee(event){
        if(!isAdmin){alert('Bạn cần quyền admin');return;} 
        const id=event.currentTarget.getAttribute('data-id');
        // Đặt trạng thái Edit, đảm bảo chỉ 1 người được edit
        isEditingEmployee = {}; 
        isEditingEmployee[id] = true; 
        populateEmployeesUI();
    }

    function cancelEdit(event){
        const id=event.currentTarget.getAttribute('data-id');
        delete isEditingEmployee[id];
        populateEmployeesUI();
    }

    function saveEmployee(event){
        if(!isAdmin){alert('Bạn cần quyền admin');return;} 
        const id=event.currentTarget.getAttribute('data-id');
        const name = document.getElementById(`edit-name-${id}`).value.trim();
        const position = document.getElementById(`edit-position-${id}`).value.trim();
        const shift = document.getElementById(`edit-shift-${id}`).value;
        const baseSalary = Number(document.getElementById(`edit-salary-${id}`).value) || 0;

        if (!name) { alert('Tên không được để trống!'); return; }
        
        showLoading();
        db.collection('employees').doc(id).update({
            name: name,
            position: position,
            shift: shift,
            baseSalary: baseSalary,
        })
        .then(() => {
            delete isEditingEmployee[id];
            alert(`Đã cập nhật thông tin nhân viên ${name}.`);
            hideLoading();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Lỗi cập nhật nhân viên');
        });
    }

    // Populate Attendance Table 
    function populateAttendanceTable(){
        attendanceTableBody.innerHTML='';
        const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : new Date('1970-01-01'); start.setHours(0,0,0);
        const end = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : new Date('3000-01-01'); end.setHours(23,59,59);
        const selectedEmployeeId = exportEmployee.value||'all'; // Đổi tên biến
        const selectedPosition = exportPosition.value||'all'; // Lấy giá trị chức vụ
        
        const filtered = attendance.filter(r=>{ 
            const d = new Date(r.date); 
            const emp = employees.find(x=>x.id===r.employeeId) || {}; // NEW: Tìm thông tin nhân viên
            
            const matchEmp = selectedEmployeeId==='all' || r.employeeId===selectedEmployeeId; 
            const matchPos = selectedPosition==='all' || (emp.position||'').trim() === selectedPosition; // NEW: Lọc theo chức vụ
            return d>=start && d<=end && matchEmp && matchPos; // Áp dụng cả hai bộ lọc
        });

        if (filtered.length === 0) {
            attendanceTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Không tìm thấy dữ liệu chấm công nào trong kỳ này.</td></tr>';
            return;
        }

        filtered.forEach(r=>{
            const emp = employees.find(x=>x.id===r.employeeId) || {};
            const finalShiftKey = r.shiftChosen || emp.shift || 'shift2'; 
            const empShift = shifts[finalShiftKey];
            let checkIn = r.checkIn || '---';
            let checkOut = r.checkOut || '---';
            let note = r.lateReason ? `Xin phép: ${r.lateReason}` : '';
            let status = '';
            let hoursText = '0 giờ 0 phút';
            let finalCheckOut = r.checkOut;

            if(r.checkIn){
                let inDT = new Date(`${r.date}T${r.checkIn}`);
                let outDT = null;

                // QUY TẮC QUÊN CHẤM RA: Nếu không có checkOut, đặt 23:00 và ghi chú quên chấm
                if (!finalCheckOut) {
                    finalCheckOut = '23:00:00';
                    outDT = new Date(`${r.date}T${finalCheckOut}`);
                    note += ` / <span class="red-text">Quên chấm ra (23:00)</span>`;
                } else {
                    outDT = new Date(`${r.date}T${finalCheckOut}`);
                }

                if(outDT <= inDT) outDT.setDate(outDT.getDate() + 1);

                const diff = Math.max(0, outDT - inDT);
                const hrs = Math.floor(diff/3600000);
                const mins = Math.round((diff%3600000)/60000);
                hoursText = `${hrs} giờ ${mins} phút`;

                // --- LOGIC TRẠNG THÁI VỚI GRACE PERIOD 5 PHÚT ---
                const shiftStart = new Date(`${r.date}T${empShift.start}`);
                const isEarlyOrOnTime = inDT.getTime() <= shiftStart.getTime();
                const isAfterGracePeriod = inDT.getTime() > (shiftStart.getTime() + GRACE_PERIOD_MS);

                if (r.edited) {
                    status = 'Sửa công (Phạt 20k)';
                } else if (!r.checkOut) {
                    status = 'Quên chấm ra (Phạt 20k)';
                } else if (isEarlyOrOnTime) {
                    status = 'Đúng giờ';
                } else if (!isAfterGracePeriod) {
                    status = 'Đúng giờ (Grace period)';
                } else if (isAfterGracePeriod) {
                    if (r.isLate) {
                        status = 'Đi muộn (Phạt 10k)';
                    } else if (r.lateReason) {
                        status = 'Đi muộn (Xin phép)';
                    } else {
                        status = 'Đi muộn (Lỗi dữ liệu củ)';
                    }
                } else {
                    status = 'Lỗi trạng thái';
                }
                // --- KẾT THÚC LOGIC TRẠNG THÁI ---
            } else {
                status = 'Vắng mặt';
            }

            const isHoliday = settings.holidays && settings.holidays.indexOf(r.date) >= 0;
            if (isHoliday) status += ' / Ngày lễ';

            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${new Date(r.date).toLocaleDateString('vi-VN')}</td>
                            <td>${emp.name||r.employeeName||'Unknown'}</td>
                            <td>${empShift?.name||'N/A'}</td>
                            <td>${checkIn}</td>
                            <td>${finalCheckOut}</td>
                            <td>${hoursText}</td>
                            <td>${status}</td>
                            <td>${note}</td>`;
            attendanceTableBody.appendChild(tr);
        });
    }

    // Add employee with auto username and default password (giữ nguyên)
    function addEmployee(){
        if(!isAdmin){
            alert('Cần quyền admin'); 
            return;
        }
        const name = document.getElementById('employeeName').value.trim();
        if(!name){
            alert('Nhập tên'); 
            return;
        }
        const position = document.getElementById('employeePosition').value.trim();
        const baseSalary = Number(document.getElementById('employeeBaseSalary').value) || 0;
        const shift = document.getElementById('employeeShift').value;
        const username = toUsername(name);
        const defaultPassword = 'thaithae';

        showLoading();
        db.collection('employees').add({
            name,
            position,
            baseSalary,
            shift,
            username,
            password: defaultPassword,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(()=>{
            document.getElementById('employeeName').value='';
            document.getElementById('employeePosition').value='';
            document.getElementById('employeeBaseSalary').value='';
            alert(`Đã thêm ${name} (username: ${username}, mật khẩu: ${defaultPassword})`);
            hideLoading();
        })
        .catch(err=>{
            console.error(err);
            hideLoading();
            alert('Lỗi thêm nhân viên');
        });
    }

    // Admin verify (giữ nguyên)
    function verifyAdmin(){
        const code = document.getElementById('adminCode').value;
        if(code==='thaithae2025@'){
            isAdmin=true;
            adminVerificationArea.style.display = 'none';
            adminFeatures.classList.remove('d-none');
            personalAttendancePanel.style.display = 'none';
            adminDashboardPanel.style.display = 'block';
            populateAttendanceTable();
            alert('Đã xác thực admin');
        } else alert('Mã admin không đúng');
    }

    // Admin Toggle (giữ nguyên)
    document.getElementById('adminToggle').addEventListener('click', () => {
        const isCurrentlyAdmin = adminDashboardPanel.style.display === 'block';
        if (isCurrentlyAdmin) {
            adminDashboardPanel.style.display = 'none';
            personalAttendancePanel.style.display = 'none';
            isAdmin = false;
        } else {
            adminDashboardPanel.style.display = 'block';
            personalAttendancePanel.style.display = 'none';
        }
    });

    // Clear attendance (giữ nguyên)
    function clearAttendance(){
        if(!isAdmin){
            alert('Cần admin'); 
            return;
        }
        if(!confirm('Xóa toàn bộ dữ liệu chấm công?')) return;
        showLoading();
        db.collection('attendance').get()
        .then(snap=>{
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            return batch.commit();
        })
        .then(()=>{
            alert('Đã xóa dữ liệu chấm công thành công');
            hideLoading();
        })
        .catch(err=>{
            console.error(err);
            hideLoading();
            alert('Lỗi xóa dữ liệu chấm công');
        });
    }
    
    // Force logout all
    document.getElementById('forceLogoutAll').addEventListener('click', () => {
        if (!isAdmin) { alert('Cần admin'); return; }
        if (!confirm('Bạn có chắc chắn muốn buộc tất cả nhân viên đăng xuất không?')) return;
        showLoading();
        db.collection('meta').doc('session').set({
            forceLogoutAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true })
        .then(() => {
            localStorage.removeItem(SESSION_KEY);
            alert('Đã buộc đăng xuất tất cả phiên.');
            hideLoading();
            location.reload(); 
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Lỗi buộc đăng xuất');
        });
    });

    // --- CHỨC NĂNG TÍNH LƯƠNG ---
    function computePayroll() {
        if (!isAdmin) { alert('Cần quyền admin'); return; }
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if (!start || !end) { alert('Vui lòng chọn đầy đủ ngày bắt đầu và ngày kết thúc!'); return; }
        
        showLoading();
        payrollResults = {};
        const startDate = new Date(start);
        const endDate = new Date(end);
        
        const filteredAttendance = attendance.filter(r => {
            const d = new Date(r.date);
            return d >= startDate && d <= endDate;
        });

        employees.forEach(emp => {
            const empAttendance = filteredAttendance.filter(r => r.employeeId === emp.id);
            if (empAttendance.length === 0) return;

            let totalWorkingMinutes = 0;
            let totalBaseSalary = Number(emp.baseSalary) || 0;
            let totalDeductions = 0;
            let latePenaltyCount = 0;
            let editPenaltyCount = 0;
            let forgotOutPenaltyCount = 0;
            let isHolidayCount = 0;
            
            empAttendance.forEach(r => {
                const finalShiftKey = r.shiftChosen || emp.shift || 'shift2'; 
                const empShift = shifts[finalShiftKey];
                let isHoliday = settings.holidays && settings.holidays.indexOf(r.date) >= 0;

                if (r.checkIn) {
                    let inDT = new Date(`${r.date}T${r.checkIn}`);
                    let finalCheckOut = r.checkOut || '23:00:00';
                    let outDT = new Date(`${r.date}T${finalCheckOut}`);
                    
                    if (outDT <= inDT) outDT.setDate(outDT.getDate() + 1);
                    
                    const diff = Math.max(0, outDT - inDT);
                    let workingMinutes = Math.round(diff / 60000);
                    
                    // Giảm công nếu quên chấm ra
                    if (!r.checkOut) {
                        workingMinutes = Math.min(workingMinutes, empShift.minutes);
                        forgotOutPenaltyCount++;
                    }

                    // Tăng gấp đôi công cho ngày lễ
                    if (isHoliday) {
                        isHolidayCount++;
                        totalWorkingMinutes += workingMinutes * 2;
                    } else {
                        totalWorkingMinutes += workingMinutes;
                    }

                    // Áp dụng phạt
                    const shiftStart = new Date(`${r.date}T${empShift.start}`);
                    const GRACE_PERIOD_MS = 5 * 60 * 1000;
                    const isAfterGracePeriod = inDT.getTime() > (shiftStart.getTime() + GRACE_PERIOD_MS);
                    
                    if (r.edited) {
                        totalDeductions += Number(settings.editPenalty) || 0;
                        editPenaltyCount++;
                    } else if (!r.checkOut) {
                        totalDeductions += Number(settings.forgotOutPenalty) || 0;
                    } else if (isAfterGracePeriod && !r.lateReason) {
                        totalDeductions += Number(settings.latePenalty) || 0;
                        latePenaltyCount++;
                    }
                }
            });

            // Lương cơ bản dựa trên giờ làm việc (tổng phút * lương/phút)
            const wagePerMinute = (Number(settings.wagePerHour) || 0) / 60;
            const wageFromHours = Math.round(totalWorkingMinutes * wagePerMinute);
            
            // Tổng lương = Lương giờ + Lương cơ bản (chỉ để tham khảo, không dùng trong tính toán) + Thưởng - Phạt
            const totalWage = wageFromHours + (Number(settings.defaultBonus) || 0) - totalDeductions;
            const finalSalary = totalWage;


            payrollResults[emp.id] = {
                name: emp.name,
                position: emp.position,
                totalWorkingMinutes: totalWorkingMinutes,
                totalWorkingHours: totalWorkingMinutes / 60,
                totalDays: empAttendance.length,
                wageFromHours: wageFromHours,
                baseSalary: totalBaseSalary,
                defaultBonus: Number(settings.defaultBonus) || 0,
                totalDeductions: totalDeductions,
                latePenaltyCount: latePenaltyCount,
                editPenaltyCount: editPenaltyCount,
                forgotOutPenaltyCount: forgotOutPenaltyCount,
                isHolidayCount: isHolidayCount,
                finalSalary: finalSalary,
                startDate: start,
                endDate: end,
            };
        });

        displayPayrollResults(payrollResults);
        hideLoading();
    }
    
    // --- CHỨC NĂNG HIỂN THỊ BẢNG LƯƠNG ---
    function displayPayrollResults(results) {
        payrollResultArea.style.display = 'block';
        payrollResult.innerHTML = '';
        printPayrollBtn.classList.remove('d-none');
        
        let grandTotal = 0;

        for (const id in results) {
            const r = results[id];
            grandTotal += r.finalSalary;
            
            const html = `
                <div class="payslip mb-4 border border-info">
                    <h5 class="text-center">${r.name} - Bảng Lương</h5>
                    <p class="text-center small text-muted">Từ ${new Date(r.startDate).toLocaleDateString('vi-VN')} đến ${new Date(r.endDate).toLocaleDateString('vi-VN')}</p>
                    <hr>
                    <div class="row small mb-2">
                        <div class="col-6"><strong>Chức vụ:</strong> ${r.position}</div>
                        <div class="col-6"><strong>Lương cơ bản (Tham khảo):</strong> ${formatVND(r.baseSalary)}</div>
                    </div>
                    
                    <h6 class="mt-3 text-primary"><i class="fas fa-clock me-1"></i> THỜI GIAN LÀM VIỆC</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">Ngày công: <strong>${r.totalDays} ngày</strong></div>
                        <div class="col-md-4">Tổng giờ làm: <strong>${(r.totalWorkingMinutes / 60).toFixed(2)} giờ</strong></div>
                        <div class="col-md-4">Lương giờ: <strong>${formatVND(r.wageFromHours)}</strong></div>
                    </div>
                    
                    <h6 class="mt-3 text-success"><i class="fas fa-plus-circle me-1"></i> PHỤ CẤP / THƯỞNG</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">Thưởng mặc định: <strong>${formatVND(r.defaultBonus)}</strong></div>
                        <div class="col-md-4">Ngày lễ (x2 công): <strong>${r.isHolidayCount} ngày</strong></div>
                    </div>
                    
                    <h6 class="mt-3 text-danger"><i class="fas fa-minus-circle me-1"></i> KHẤU TRỪ / PHẠT</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">Phạt đi muộn (x${r.latePenaltyCount}): <strong>${formatVND(r.latePenaltyCount * settings.latePenalty)}</strong></div>
                        <div class="col-md-4">Phạt sửa công (x${r.editPenaltyCount}): <strong>${formatVND(r.editPenaltyCount * settings.editPenalty)}</strong></div>
                        <div class="col-md-4">Phạt quên chấm ra (x${r.forgotOutPenaltyCount}): <strong>${formatVND(r.forgotOutPenaltyCount * settings.forgotOutPenalty)}</strong></div>
                        <div class="col-12">Tổng Khấu trừ: <strong class="text-danger">${formatVND(r.totalDeductions)}</strong></div>
                    </div>

                    <div class="summary-row mt-3 p-2 border-top border-bottom">
                        <div class="row">
                            <div class="col-6"><strong>TỔNG TIỀN LƯƠNG THỰC LĨ:</strong></div>
                            <div class="col-6 text-end"><strong class="text-success h5">${formatVND(r.finalSalary)}</strong></div>
                        </div>
                    </div>
                </div>
            `;
            payrollResult.innerHTML += html;
        }
        
        // Tổng hợp chung
        payrollResult.innerHTML += `<div class="alert alert-primary mt-4">
                                        <h4>TỔNG THANH TOÁN KỲ NÀY: <span class="float-end">${formatVND(grandTotal)}</span></h4>
                                   </div>`;
    }

    // Export Payroll Excel
    function exportPayrollExcel() {
        if (Object.keys(payrollResults).length === 0) {
            alert('Chưa có dữ liệu bảng lương để xuất.');
            return;
        }

        const data = [
            ["BẢNG LƯƠNG TỔNG HỢP"],
            [`Từ ngày ${payrollResults[Object.keys(payrollResults)[0]].startDate} đến ${payrollResults[Object.keys(payrollResults)[0]].endDate}`],
            [],
            ["ID", "Tên Nhân viên", "Chức vụ", "Tổng Ngày Công", "Tổng Giờ Làm (Giờ)", "Lương Giờ (VND)", "Thưởng Mặc Định (VND)", "Tổng Khấu Trừ (VND)", "Số lần Phạt Đi muộn", "Số lần Phạt Sửa công", "Số lần Phạt Quên Ra", "LƯƠNG THỰC LĨ (VND)"]
        ];

        let grandTotal = 0;

        for (const id in payrollResults) {
            const r = payrollResults[id];
            grandTotal += r.finalSalary;
            data.push([
                id,
                r.name,
                r.position,
                r.totalDays,
                (r.totalWorkingMinutes / 60).toFixed(2),
                r.wageFromHours,
                r.defaultBonus,
                r.totalDeductions,
                r.latePenaltyCount,
                r.editPenaltyCount,
                r.forgotOutPenaltyCount,
                r.finalSalary
            ]);
        }
        
        data.push([]);
        data.push(["", "", "", "", "", "", "TỔNG THANH TOÁN:", "", "", "", "", grandTotal]);

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Bảng Lương");
        
        const fileName = `Bang_luong_tong_hop_${payrollResults[Object.keys(payrollResults)[0]].startDate}_to_${payrollResults[Object.keys(payrollResults)[0]].endDate}.xlsx`;
        XLSX.writeFile(wb, fileName);
        alert('Đã xuất Bảng lương Tổng hợp thành công!');
    }


    // Print function for all payslips
    function generatePayslipHTML(results) {
        if (Object.keys(results).length === 0) {
            alert('Chưa có dữ liệu bảng lương để in/xuất.');
            return;
        }

        let htmlContent = '';
        for (const id in results) {
            const r = results[id];
            
            const payslip = `
                <div class="payslip-print-section mb-5 p-4 border border-secondary" style="page-break-after: always; width: 100%; max-width: 800px; margin: 0 auto;">
                    <h3 class="text-center text-primary">PHIẾU LƯƠNG THAI THAE</h3>
                    <h4 class="text-center text-secondary">${r.name} (${r.position})</h4>
                    <p class="text-center small text-muted">Kỳ: ${new Date(r.startDate).toLocaleDateString('vi-VN')} - ${new Date(r.endDate).toLocaleDateString('vi-VN')}</p>
                    <hr>
                    
                    <h5 class="text-primary mb-3">1. Tổng Quan Công Việc</h5>
                    <table class="table table-bordered table-sm small">
                        <tbody>
                            <tr><td>Ngày công thực tế:</td><td class="text-end">${r.totalDays} ngày</td></tr>
                            <tr><td>Tổng thời gian làm:</td><td class="text-end">${(r.totalWorkingMinutes / 60).toFixed(2)} giờ</td></tr>
                            <tr><td>Ngày lễ (Lương x2):</td><td class="text-end">${r.isHolidayCount} ngày</td></tr>
                        </tbody>
                    </table>

                    <h5 class="text-success mt-4 mb-3">2. Thu Nhập</h5>
                    <table class="table table-bordered table-sm small">
                        <tbody>
                            <tr><td>Lương cơ bản (Tham khảo):</td><td class="text-end">${formatVND(r.baseSalary)}</td></tr>
                            <tr><td>Thu nhập từ giờ làm việc:</td><td class="text-end text-success">${formatVND(r.wageFromHours)}</td></tr>
                            <tr><td>Thưởng mặc định:</td><td class="text-end text-success">${formatVND(r.defaultBonus)}</td></tr>
                        </tbody>
                    </table>

                    <h5 class="text-danger mt-4 mb-3">3. Khấu Trừ & Phạt</h5>
                    <table class="table table-bordered table-sm small">
                        <tbody>
                            <tr><td>Phạt đi muộn (x${r.latePenaltyCount}):</td><td class="text-end text-danger">${formatVND(r.latePenaltyCount * settings.latePenalty)}</td></tr>
                            <tr><td>Phạt sửa/quên công (x${r.editPenaltyCount}):</td><td class="text-end text-danger">${formatVND(r.editPenaltyCount * settings.editPenalty)}</td></tr>
                            <tr><td>Phạt quên chấm ra (x${r.forgotOutPenaltyCount}):</td><td class="text-end text-danger">${formatVND(r.forgotOutPenaltyCount * settings.forgotOutPenalty)}</td></tr>
                            <tr class="table-warning"><td><strong>TỔNG KHẤU TRỪ:</strong></td><td class="text-end text-danger"><strong>${formatVND(r.totalDeductions)}</strong></td></tr>
                        </tbody>
                    </table>

                    <div class="alert alert-info mt-4">
                        <h4 class="mb-0">TỔNG LƯƠNG THỰC LĨ: <span class="float-end">${formatVND(r.finalSalary)}</span></h4>
                    </div>
                </div>
            `;
            htmlContent += payslip;
        }
        
        payslipContainer.innerHTML = htmlContent;
        const printExportModal = new bootstrap.Modal(document.getElementById('printExportModal'));
        printExportModal.show();
    }
    
    function printAllPayslips() {
        const content = document.getElementById('payslipContainer').innerHTML;
        const originalBody = document.body.innerHTML;
        
        document.body.innerHTML = `
            <div style="font-family: 'Inter', sans-serif; padding: 20px;">
                ${content}
            </div>
        `;
        
        window.print();
        
        // Reload original content after printing
        document.body.innerHTML = originalBody;
        location.reload(); 
    }

    // --- CHỨC NĂNG LƯU CÀI ĐẶT CHUNG ---
    function saveSettings() {
        if (!isAdmin) { alert('Cần quyền admin'); return; }
        
        const wagePerHour = Number(document.getElementById('wagePerHour').value) || 0;
        const defaultBonus = Number(document.getElementById('defaultBonus').value) || 0;
        const defaultPenalty = Number(document.getElementById('defaultPenalty').value) || 0;
        const latePenalty = Number(document.getElementById('latePenalty').value) || 0;
        const editPenalty = Number(document.getElementById('editPenalty').value) || 0;
        const forgotOutPenalty = Number(document.getElementById('forgotOutPenalty').value) || 0;
        const wifiIpAddress = document.getElementById('wifiIpAddress').value.trim();
        const holidayList = document.getElementById('holidayList').value.split(/,?\s*\n?,?\s*/).map(s => s.trim()).filter(s => s.match(/^\d{4}-\d{2}-\d{2}$/)); // Lọc và chuẩn hóa YYYY-MM-DD
        
        showLoading();
        db.collection('settings').doc('payroll').set({
            wagePerHour,
            defaultBonus,
            defaultPenalty,
            latePenalty,
            editPenalty,
            forgotOutPenalty,
            wifiIpAddress,
            holidays: holidayList 
        })
        .then(() => {
            alert('Đã lưu Cài đặt chung thành công.');
            loadSettings(); // Tải lại cài đặt sau khi lưu
            hideLoading();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Lỗi lưu cài đặt');
        });
    }

    // --- CHỨC NĂNG TẢI CÀI ĐẶT CHUNG ---
    function loadSettings() {
        db.collection('settings').doc('payroll').get()
        .then(doc => {
            if (doc.exists) {
                settings = { ...settings, ...doc.data() };
                
                document.getElementById('wagePerHour').value = settings.wagePerHour;
                document.getElementById('defaultBonus').value = settings.defaultBonus;
                document.getElementById('defaultPenalty').value = settings.defaultPenalty;
                document.getElementById('latePenalty').value = settings.latePenalty;
                document.getElementById('editPenalty').value = settings.editPenalty;
                document.getElementById('forgotOutPenalty').value = settings.forgotOutPenalty;
                document.getElementById('wifiIpAddress').value = settings.wifiIpAddress;
                
                // Hiển thị ngày lễ hiện tại
                const holidayInputText = settings.holidays ? settings.holidays.join('\n') : '';
                document.getElementById('holidayList').value = holidayInputText;
                
                if (settings.holidays && settings.holidays.length > 0) {
                    document.getElementById('currentHolidays').innerHTML = '<strong>Ngày lễ hiện tại:</strong> ' + settings.holidays.map(d => new Date(d).toLocaleDateString('vi-VN')).join(', ');
                } else {
                    document.getElementById('currentHolidays').textContent = 'Chưa có ngày lễ nào được thiết lập.';
                }
            }
        })
        .catch(err => console.error("Lỗi tải cài đặt:", err));
    }

    // --- CHỨC NĂNG LOGIN VÀ SESSION ---

    function saveSession(user) {
        const sessionData = {
            id: user.id,
            name: user.name,
            username: user.username,
            position: user.position,
            shift: user.shift,
            loginAt: Date.now(),
            expiresAt: Date.now() + SESSION_DURATION_MS
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
        loggedInUser = user;
        updateUIOnLogin();
    }

    function tryRestoreSession() {
        const sessionData = localStorage.getItem(SESSION_KEY);
        if (sessionData) {
            const session = JSON.parse(sessionData);
            if (session.expiresAt > Date.now()) {
                const user = employees.find(e => e.id === session.id);
                if (user) {
                    loggedInUser = user;
                    updateUIOnLogin();
                    return;
                }
            }
        }
        logout();
    }

    function logout() {
        localStorage.removeItem(SESSION_KEY);
        loggedInUser = null;
        updateUIOnLogout();
    }
    
    function updateSessionTimeLeft() {
        const sessionData = localStorage.getItem(SESSION_KEY);
        if (sessionData) {
            const session = JSON.parse(sessionData);
            const timeLeftMs = session.expiresAt - Date.now();
            if (timeLeftMs > 0) {
                const hours = Math.floor(timeLeftMs / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
                document.querySelector('#clockingArea p.small').textContent = `Phiên đăng nhập còn hiệu lực ${hours} giờ ${minutes} phút`;
            } else {
                 document.querySelector('#clockingArea p.small').textContent = `Phiên đăng nhập đã hết hạn`;
                 logout();
            }
        }
    }
    setInterval(updateSessionTimeLeft, 60000); // Cập nhật mỗi phút

    function updateUIOnLogin() {
        document.getElementById('loginArea').classList.add('d-none');
        document.getElementById('clockingArea').classList.remove('d-none');
        document.getElementById('loggedName').textContent = loggedInUser.name;
        document.getElementById('loggedPosition').textContent = loggedInUser.position || 'Nhân viên';
        document.getElementById('loggedShift').textContent = shifts[loggedInUser.shift]?.name || 'N/A';
        
        // Hiển thị lịch sử cá nhân
        adminDashboardPanel.style.display = 'none'; // Ẩn admin nếu đang hiển thị
        personalAttendancePanel.style.display = 'block'; 
        loadPersonalAttendance(loggedInUser.id);

        // Reset và populate shift select
        shiftSelect.innerHTML = '';
        Object.keys(shifts).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = shifts[key].name;
            if (key === loggedInUser.shift) {
                option.selected = true;
            }
            shiftSelect.appendChild(option);
        });

        checkWeeklyLateNotes(loggedInUser.id);
        updateSessionTimeLeft();
    }

    function updateUIOnLogout() {
        document.getElementById('loginArea').classList.remove('d-none');
        document.getElementById('clockingArea').classList.add('d-none');
        document.getElementById('loginMessage').textContent = '';
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
        personalAttendancePanel.style.display = 'none';
        
        if (unsubscribePersonalAttendance) {
            unsubscribePersonalAttendance();
        }
    }

    // --- EVENT LISTENERS (Được giữ nguyên) ---

    // Login (giữ nguyên)
    document.getElementById('loginBtn').addEventListener('click', () => {
        const username = document.getElementById('loginUsername').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;
        const msg = document.getElementById('loginMessage');
        
        const user = employees.find(e => e.username === username && e.password === password);

        if (user) {
            msg.textContent = 'Đăng nhập thành công!';
            saveSession(user);
        } else {
            msg.textContent = 'Sai tên đăng nhập hoặc mật khẩu.';
            msg.classList.add('text-danger');
        }
    });
    
    // Login by ID (giữ nguyên)
    document.getElementById('loginByIdBtn').addEventListener('click', () => {
        const input = prompt("Nhập ID nhân viên:");
        if (!input) return;
        const id = input.trim();
        
        const user = employees.find(e => e.id === id);
        
        if (user) {
            saveSession(user);
        } else {
            alert('ID không hợp lệ.');
        }
    });


    // Logout (giữ nguyên)
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Check In
    document.getElementById('checkInBtn').addEventListener('click', async () => {
        if (!loggedInUser) return;
        
        const isAuthorized = await isConnectedToAuthorizedWifi();
        if (!isAuthorized) return; 

        showLoading();
        const now = new Date();
        const dateString = now.toISOString().split('T')[0];
        const timeString = now.toLocaleTimeString('en-US', { hour12: false });
        const shiftChosen = shiftSelect.value;
        const defaultShift = loggedInUser.shift;
        const empShift = shifts[shiftChosen];
        const shiftStart = new Date(`${dateString}T${empShift.start}`);
        const isLate = now.getTime() > (shiftStart.getTime() + GRACE_PERIOD_MS);
        
        const lateReason = lateReasonInput.value.trim();

        // Kiểm tra xem đã chấm công vào hôm nay chưa
        const existingDoc = await db.collection('attendance')
            .where('employeeId', '==', loggedInUser.id)
            .where('date', '==', dateString)
            .limit(1)
            .get();
            
        if (!existingDoc.empty) {
            hideLoading();
            alert('Bạn đã chấm công vào ngày hôm nay rồi!');
            return;
        }

        db.collection('attendance').add({
            employeeId: loggedInUser.id,
            employeeName: loggedInUser.name,
            date: dateString,
            checkIn: timeString,
            checkOut: null,
            shiftDefault: defaultShift,
            shiftChosen: shiftChosen,
            isLate: isLate,
            lateReason: lateReason || null, 
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            alert(`Chấm công VÀO thành công lúc ${timeString}.`);
            lateReasonInput.value = ''; // Clear lý do sau khi chấm
            checkWeeklyLateNotes(loggedInUser.id);
            hideLoading();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Lỗi chấm công VÀO');
        });
    });

    // Check Out
    document.getElementById('checkOutBtn').addEventListener('click', async () => {
        if (!loggedInUser) return;
        
        const isAuthorized = await isConnectedToAuthorizedWifi();
        if (!isAuthorized) return;

        showLoading();
        const now = new Date();
        let dateString = now.toISOString().split('T')[0];
        const timeString = now.toLocaleTimeString('en-US', { hour12: false });

        // Trường hợp qua đêm, checkOut ngày hôm sau
        let existingDoc = await db.collection('attendance')
            .where('employeeId', '==', loggedInUser.id)
            .where('date', '==', dateString)
            .where('checkOut', '==', null)
            .limit(1)
            .get();

        // Nếu không tìm thấy công ngày hôm nay, thử tìm công ngày hôm qua (cho ca qua đêm)
        if (existingDoc.empty) {
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            dateString = yesterday.toISOString().split('T')[0];
            
            existingDoc = await db.collection('attendance')
                .where('employeeId', '==', loggedInUser.id)
                .where('date', '==', dateString)
                .where('checkOut', '==', null)
                .limit(1)
                .get();
        }

        if (existingDoc.empty) {
            hideLoading();
            alert('Bạn chưa chấm công VÀO hoặc đã chấm công RA rồi!');
            return;
        }

        const docId = existingDoc.docs[0].id;

        db.collection('attendance').doc(docId).update({
            checkOut: timeString,
        })
        .then(() => {
            alert(`Chấm công RA thành công lúc ${timeString}.`);
            hideLoading();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Lỗi chấm công RA');
        });
    });
    
    // Submit Late Request (cho phép ghi chú trước khi chấm công vào)
    document.getElementById('submitLateRequestBtn').addEventListener('click', () => {
        alert('Vui lòng ghi lý do xin phép vào ô Ghi chú. Khi bạn chấm công VÀO, lý do đó sẽ được lưu lại.');
    });

    // Admin Features Listeners
    document.getElementById('addEmployee').addEventListener('click', addEmployee);
    document.getElementById('verifyAdmin').addEventListener('click', verifyAdmin);
    document.getElementById('clearDataBtn').addEventListener('click', clearAttendance);
    document.getElementById('saveSettings').addEventListener('click', saveSettings);
    document.getElementById('applyFilterBtn').addEventListener('click', populateAttendanceTable);
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);
    document.getElementById('computePayrollBtn').addEventListener('click', computePayroll);
    document.getElementById('printPayrollBtn').addEventListener('click', () => generatePayslipHTML(payrollResults));
    document.getElementById('printAllPayslipsBtn').addEventListener('click', printAllPayslips);
    document.getElementById('exportPayslipExcelBtn').addEventListener('click', exportPayrollExcel);

    // Initialize Date Filters to Today
    document.getElementById('startDate').valueAsDate = new Date(); 
    document.getElementById('endDate').valueAsDate = new Date();

    // Export to Excel function (được giữ nguyên)
    function exportToExcel() {
        if (!isAdmin) {
            alert('Chỉ admin mới được xuất file.');
            return;
        }

        const table = document.getElementById('attendanceTable');
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Chấm Công");
        
        const fileName = `Du_lieu_Cham_Cong_${document.getElementById('startDate').value}_to_${document.getElementById('endDate').value}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
    
    // Auto-logout check on metadata change
    document.addEventListener('DOMContentLoaded', () => {
        db.collection('meta').doc('session').onSnapshot(doc=>{
            if(doc.exists && doc.data().forceLogoutAt){
                const s = localStorage.getItem(SESSION_KEY);
                if(s){
                    const obj = JSON.parse(s);
                    // Nếu thời điểm logout bắt buộc lớn hơn thời điểm login của nhân viên
                    if(obj && doc.data().forceLogoutAt.toMillis() > (obj.loginAt||0)){
                        localStorage.removeItem(SESSION_KEY);
                        location.reload();
                    }
                }
            }
        });

        loadSettings();
        loadEmployees();
        loadAttendance();
        setTimeout(()=>{ tryRestoreSession(); }, 800);
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>