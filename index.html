<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Chấm công</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Thêm Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* Giữ nguyên các style hiện có */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #2c3e50;
            border-color: #2c3e50;
        }
        .btn-primary:hover {
            background-color: #1a252f;
            border-color: #1a252f;
        }
        .btn-success {
            background-color: #27ae60;
            border-color: #27ae60;
        }
        .btn-danger {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }
        .admin-section {
            background-color: #fef9e7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .clock-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            margin: 15px 0;
        }
        .employee-card {
            transition: transform 0.2s;
        }
        .employee-card:hover {
            transform: translateY(-5px);
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .language-selector {
            position: absolute;
            right: 15px;
            top: 10px;
        }
        .language-flag {
            width: 24px;
            height: 16px;
            margin-right: 5px;
            vertical-align: middle;
        }
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            .language-selector {
                position: static;
                margin-top: 10px;
                text-align: center;
            }
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-clock me-2"></i><span data-lang="app-title">Quản lý Chấm công</span>
            </a>
            <button class="btn btn-outline-light" id="adminToggle">
                <i class="fas fa-cog me-1"></i><span data-lang="admin-mode">Chế độ Admin</span>
            </button>
            
            <!-- Language Selector -->
            <div class="language-selector">
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA5MDAgNjAwIj48cGF0aCBmaWxsPSIjZGEyNTI1IiBkPSJtMCwwIHY2MDAgaDkwMCB2LTYwMCB6Ii8+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTAgMCIgaGVpZ2h0PSIzMDAiIHdpZHRoPSI5MDAiLz48cGF0aCBmaWxsPSIjMDA3NzBmIiBkPSJNMCwwIGg5MDAgdjIwMCB6Ii8+PC9zdmc+" class="language-flag" alt="Việt Nam">
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-lang="vi">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA5MDAgNjAwIj48cGF0aCBmaWxsPSIjZGEyNTI1IiBkPSJtMCwwIHY2MDAgaDkwMCB2LTYwMCB6Ii8+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTAgMCIgaGVpZ2h0PSIzMDAiIHdpZHRoPSI5MDAiLz48cGF0aCBmaWxsPSIjMDA3NzBmIiBkPSJNMCwwIGg5MDAgdjIwMCB6Ii8+PC9zdmc+" class="language-flag" alt="Việt Nam"> Tiếng Việt
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-lang="en">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjAwIDYwMCI+PHBhdGggZmlsbD0iIzAyMzE4ZiIgZD0iTTAgMGgxMjAwdjYwMEgweiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0wIDBsMTIwMCA2MDBIMHpNMTIwMCBsLTEyMDAgNjAwaDEyMDB6Ii8+PHBhdGggZmlsbD0iI2M2MGEyNSIgZD0iTTQwMCAwaDQwMHY2MDBIMHoiLz48cGF0aCBmaWxsPSIjYzYwYTI1IiBkPSJNMCAyNTBoMTIwMHYxMDBIMHoiLz48L3N2Zz4=" class="language-flag" alt="English"> English
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-lang="th">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA5MDAgNjAwIj48cGF0aCBmaWxsPSIjZjEwIiBkPSJtMCwwIHY2MDAgaDkwMCB2LTYwMCB6Ii8+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTAgMTAwaDkwMHY0MDBIMHoiLz48cGF0aCBmaWxsPSIjMDA1OGExIiBkPSJNMCAyMDBoOTAwdjIwMEgweiIvPjwvc3ZnPg==" class="language-flag" alt="Thailand"> ไทย
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Loading Indicator -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2" data-lang="loading">Đang tải dữ liệu...</p>
        </div>

        <!-- Admin Section (Hidden by default) -->
        <div class="admin-section d-none" id="adminSection">
            <h4><i class="fas fa-lock me-2"></i><span data-lang="admin-area">Khu vực Quản trị</span></h4>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="password" class="form-control" id="adminCode" placeholder="Nhập mã khóa admin" data-lang-ph="admin-code-placeholder">
                        <button class="btn btn-primary" id="verifyAdmin">
                            <i class="fas fa-check me-1"></i><span data-lang="verify">Xác nhận</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="admin-features d-none" id="adminFeatures">
                <h5 class="mb-3" data-lang="employee-management">Quản lý nhân viên</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="employeeName" placeholder="Tên nhân viên" data-lang-ph="employee-name-placeholder">
                            <input type="text" class="form-control" id="employeePosition" placeholder="Chức vụ" data-lang-ph="employee-position-placeholder">
                            <button class="btn btn-success" id="addEmployee">
                                <i class="fas fa-plus me-1"></i><span data-lang="add-employee">Thêm nhân viên</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <button class="btn btn-danger" id="clearDataBtn">
                            <i class="fas fa-trash me-1"></i><span data-lang="clear-attendance">Xóa dữ liệu chấm công</span>
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped" id="employeesTable">
                        <thead>
                            <tr>
                                <th data-lang="id">ID</th>
                                <th data-lang="employee-name">Tên nhân viên</th>
                                <th data-lang="position">Chức vụ</th>
                                <th data-lang="actions">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Employees will be listed here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Current Time Display -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title" data-lang="current-time">Thời gian hiện tại</h5>
                        <div class="clock-display" id="currentTime">00:00:00</div>
                        <div id="currentDate">Thứ Hai, ngày 01 tháng 01 năm 2023</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee Check-in/out Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i><span data-lang="check-in">Chấm công vào</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="checkInEmployee" class="form-label" data-lang="select-employee">Chọn nhân viên</label>
                            <select class="form-select" id="checkInEmployee">
                                <option selected>-- Chọn nhân viên --</option>
                                <!-- Employees will be populated here -->
                            </select>
                        </div>
                        <button class="btn btn-success w-100" id="checkInBtn">
                            <i class="fas fa-fingerprint me-2"></i><span data-lang="check-in">Chấm công vào</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-sign-out-alt me-2"></i><span data-lang="check-out">Chấm công ra</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="checkOutEmployee" class="form-label" data-lang="select-employee">Chọn nhân viên</label>
                            <select class="form-select" id="checkOutEmployee">
                                <option selected>-- Chọn nhân viên --</option>
                                <!-- Employees will be populated here -->
                            </select>
                        </div>
                        <button class="btn btn-danger w-100" id="checkOutBtn">
                            <i class="fas fa-fingerprint me-2"></i><span data-lang="check-out">Chấm công ra</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Export Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-file-export me-2"></i><span data-lang="data-export">Trích xuất dữ liệu</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="startDate" class="form-label" data-lang="from-date">Từ ngày</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-3">
                                <label for="endDate" class="form-label" data-lang="to-date">Đến ngày</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                            <div class="col-md-3">
                                <label for="exportEmployee" class="form-label" data-lang="employee">Nhân viên</label>
                                <select class="form-select" id="exportEmployee">
                                    <option value="all" data-lang="all-employees">Tất cả nhân viên</option>
                                    <!-- Employees will be populated here -->
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="exportBtn">
                                    <i class="fas fa-file-excel me-2"></i><span data-lang="export-excel">Xuất file Excel</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped" id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th data-lang="date">Ngày</th>
                                        <th data-lang="employee-name">Nhân viên</th>
                                        <th data-lang="position">Chức vụ</th>
                                        <th data-lang="check-in-time">Giờ vào</th>
                                        <th data-lang="check-out-time">Giờ ra</th>
                                        <th data-lang="working-time">Thời gian làm việc</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Attendance records will be listed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cấu hình Firebase - THAY THẾ VỚI CẤU HÌNH CỦA BẠN
            const firebaseConfig = {
  apiKey: "AIzaSyD3LxaZzvFsbtzA4VRYjVWvIOdqgyNYO2o",
  authDomain: "quan-ly-cham-cong-105da.firebaseapp.com",
  projectId: "quan-ly-cham-cong-105da",
  storageBucket: "quan-ly-cham-cong-105da.firebasestorage.app",
  messagingSenderId: "226837876955",
  appId: "1:226837876955:web:883453c0b19b25098bbcfe",
  measurementId: "G-KLZTCZF14B"
};
            
            // Khởi tạo Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            
            // Initialize data
            let employees = [];
            let attendance = [];
            let isAdmin = false;
            let currentLanguage = 'vi';
            let unsubscribeEmployees = null;
            let unsubscribeAttendance = null;
            
            // Language translations
            const translations = {
                'vi': {
                    'app-title': 'Quản lý Chấm công',
                    'admin-mode': 'Chế độ Admin',
                    'admin-area': 'Khu vực Quản trị',
                    'admin-code-placeholder': 'Nhập mã khóa admin',
                    'verify': 'Xác nhận',
                    'employee-management': 'Quản lý nhân viên',
                    'employee-name-placeholder': 'Tên nhân viên',
                    'employee-position-placeholder': 'Chức vụ',
                    'add-employee': 'Thêm nhân viên',
                    'clear-attendance': 'Xóa dữ liệu chấm công',
                    'id': 'ID',
                    'employee-name': 'Tên nhân viên',
                    'position': 'Chức vụ',
                    'actions': 'Hành động',
                    'current-time': 'Thời gian hiện tại',
                    'check-in': 'Chấm công vào',
                    'check-out': 'Chấm công ra',
                    'select-employee': 'Chọn nhân viên',
                    'data-export': 'Trích xuất dữ liệu',
                    'from-date': 'Từ ngày',
                    'to-date': 'Đến ngày',
                    'employee': 'Nhân viên',
                    'all-employees': 'Tất cả nhân viên',
                    'export-excel': 'Xuất file Excel',
                    'date': 'Ngày',
                    'check-in-time': 'Giờ vào',
                    'check-out-time': 'Giờ ra',
                    'working-time': 'Thời gian làm việc',
                    'delete': 'Xóa',
                    'clear-data-confirm': 'Bạn có chắc chắn muốn xóa tất cả dữ liệu chấm công?',
                    'data-cleared': 'Đã xóa tất cả dữ liệu chấm công',
                    'not-checked-in': 'Chưa chấm',
                    'not-checked-out': 'Chưa chấm ra',
                    'loading': 'Đang tải dữ liệu...',
                    'connection-error': 'Lỗi kết nối. Vui lòng thử lại.'
                },
                'en': {
                    'app-title': 'Attendance Management',
                    'admin-mode': 'Admin Mode',
                    'admin-area': 'Admin Area',
                    'admin-code-placeholder': 'Enter admin code',
                    'verify': 'Verify',
                    'employee-management': 'Employee Management',
                    'employee-name-placeholder': 'Employee name',
                    'employee-position-placeholder': 'Position',
                    'add-employee': 'Add Employee',
                    'clear-attendance': 'Clear Attendance Data',
                    'id': 'ID',
                    'employee-name': 'Employee Name',
                    'position': 'Position',
                    'actions': 'Actions',
                    'current-time': 'Current Time',
                    'check-in': 'Check In',
                    'check-out': 'Check Out',
                    'select-employee': 'Select Employee',
                    'data-export': 'Data Export',
                    'from-date': 'From Date',
                    'to-date': 'To Date',
                    'employee': 'Employee',
                    'all-employees': 'All Employees',
                    'export-excel': 'Export Excel File',
                    'date': 'Date',
                    'check-in-time': 'Check In Time',
                    'check-out-time': 'Check Out Time',
                    'working-time': 'Working Time',
                    'delete': 'Delete',
                    'clear-data-confirm': 'Are you sure you want to clear all attendance data?',
                    'data-cleared': 'All attendance data has been cleared',
                    'not-checked-in': 'Not checked in',
                    'not-checked-out': 'Not checked out',
                    'loading': 'Loading data...',
                    'connection-error': 'Connection error. Please try again.'
                },
                'th': {
                    'app-title': 'ระบบจัดการการเข้างาน',
                    'admin-mode': 'โหมดผู้ดูแล',
                    'admin-area': 'พื้นที่ผู้ดูแล',
                    'admin-code-placeholder': 'ใส่รหัสผู้ดูแล',
                    'verify': 'ยืนยัน',
                    'employee-management': 'การจัดการพนักงาน',
                    'employee-name-placeholder': 'ชื่อพนักงาน',
                    'employee-position-placeholder': 'ตำแหน่ง',
                    'add-employee': 'เพิ่มพนักงาน',
                    'clear-attendance': 'ลบข้อมูลการเข้างาน',
                    'id': 'ID',
                    'employee-name': 'ชื่อพนักงาน',
                    'position': 'ตำแหน่ง',
                    'actions': 'การดำเนินการ',
                    'current-time': 'เวลาปัจจุบัน',
                    'check-in': 'เช็คอิน',
                    'check-out': 'เช็คเอาท์',
                    'select-employee': 'เลือกพนักงาน',
                    'data-export': 'การส่งออกข้อมูล',
                    'from-date': 'จากวันที่',
                    'to-date': 'ถึงวันที่',
                    'employee': 'พนักงาน',
                    'all-employees': 'พนักงานทั้งหมด',
                    'export-excel': 'ส่งออกไฟล์ Excel',
                    'date': 'วันที่',
                    'check-in-time': 'เวลาเข้างาน',
                    'check-out-time': 'เวลาออกงาน',
                    'working-time': 'เวลาทำงาน',
                    'delete': 'ลบ',
                    'clear-data-confirm': 'คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลการเข้างานทั้งหมด?',
                    'data-cleared': 'ลบข้อมูลการเข้างานทั้งหมดแล้ว',
                    'not-checked-in': 'ยังไม่ได้เช็คอิน',
                    'not-checked-out': 'ยังไม่ได้เช็คเอาท์',
                    'loading': 'กำลังโหลดข้อมูล...',
                    'connection-error': 'ข้อผิดพลาดในการเชื่อมต่อ กรุณาลองอีกครั้ง'
                }
            };
            
            // DOM Elements
            const currentTimeElement = document.getElementById('currentTime');
            const currentDateElement = document.getElementById('currentDate');
            const adminSection = document.getElementById('adminSection');
            const adminFeatures = document.getElementById('adminFeatures');
            const adminToggle = document.getElementById('adminToggle');
            const verifyAdminBtn = document.getElementById('verifyAdmin');
            const adminCodeInput = document.getElementById('adminCode');
            const addEmployeeBtn = document.getElementById('addEmployee');
            const employeeNameInput = document.getElementById('employeeName');
            const employeePositionInput = document.getElementById('employeePosition');
            const employeesTable = document.getElementById('employeesTable');
            const checkInEmployee = document.getElementById('checkInEmployee');
            const checkOutEmployee = document.getElementById('checkOutEmployee');
            const exportEmployee = document.getElementById('exportEmployee');
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const exportBtn = document.getElementById('exportBtn');
            const attendanceTable = document.getElementById('attendanceTable');
            const clearDataBtn = document.getElementById('clearDataBtn');
            const languageLinks = document.querySelectorAll('.dropdown-item[data-lang]');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // Set default dates for export
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            startDateInput.valueAsDate = firstDay;
            endDateInput.valueAsDate = today;

            
            // Hiển thị loading
            function showLoading() {
                loadingIndicator.style.display = 'block';
            }
            
            // Ẩn loading
            function hideLoading() {
                loadingIndicator.style.display = 'none';
            }
            
            // Update clock
            function updateClock() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('vi-VN');
                const dateOptions = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                
                let dateStr;
                if (currentLanguage === 'vi') {
                    dateStr = now.toLocaleDateString('vi-VN', dateOptions);
                } else if (currentLanguage === 'en') {
                    dateStr = now.toLocaleDateString('en-US', dateOptions);
                } else if (currentLanguage === 'th') {
                    dateStr = now.toLocaleDateString('th-TH', dateOptions);
                }
                
                currentTimeElement.textContent = timeStr;
                currentDateElement.textContent = dateStr;
            }
            
            setInterval(updateClock, 1000);
            updateClock();
            
            // Change language
            function changeLanguage(lang) {
                currentLanguage = lang;
                
                // Update all elements with data-lang attribute
                document.querySelectorAll('[data-lang]').forEach(element => {
                    const key = element.getAttribute('data-lang');
                    if (translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });
                
                // Update all placeholder elements with data-lang-ph attribute
                document.querySelectorAll('[data-lang-ph]').forEach(element => {
                    const key = element.getAttribute('data-lang-ph');
                    if (translations[lang][key]) {
                        element.placeholder = translations[lang][key];
                    }
                });
                
                // Update dropdown options
                const allEmployeesOption = exportEmployee.querySelector('option[value="all"]');
                if (allEmployeesOption && translations[lang]['all-employees']) {
                    allEmployeesOption.textContent = translations[lang]['all-employees'];
                }
                
                // Repopulate tables to update content
                populateEmployeesTable();
                populateAttendanceTable();
            }
            
            // Lấy dữ liệu nhân viên từ Firestore
            function loadEmployees() {
                showLoading();
                if (unsubscribeEmployees) {
                    unsubscribeEmployees(); // Hủy lắng nghe trước đó nếu có
                }
                
                unsubscribeEmployees = db.collection('employees')
                    .onSnapshot(snapshot => {
                        employees = [];
                        snapshot.forEach(doc => {
                            employees.push({ id: doc.id, ...doc.data() });
                        });
                        populateEmployeeDropdowns();
                        populateEmployeesTable();
                        hideLoading();
                    }, error => {
                        console.error('Error loading employees:', error);
                        alert(translations[currentLanguage]['connection-error']);
                        hideLoading();
                    });
            }
            
            // Lấy dữ liệu chấm công từ Firestore
            function loadAttendance() {
                showLoading();
                if (unsubscribeAttendance) {
                    unsubscribeAttendance(); // Hủy lắng nghe trước đó nếu có
                }
                
                unsubscribeAttendance = db.collection('attendance')
                    .orderBy('date', 'desc')
                    .onSnapshot(snapshot => {
                        attendance = [];
                        snapshot.forEach(doc => {
                            attendance.push({ id: doc.id, ...doc.data() });
                        });
                        populateAttendanceTable();
                        hideLoading();
                    }, error => {
                        console.error('Error loading attendance:', error);
                        alert(translations[currentLanguage]['connection-error']);
                        hideLoading();
                    });
            }
            
            // Populate employee dropdowns
            function populateEmployeeDropdowns() {
                // Clear existing options
                checkInEmployee.innerHTML = '<option selected>-- Chọn nhân viên --</option>';
                checkOutEmployee.innerHTML = '<option selected>-- Chọn nhân viên --</option>';
                exportEmployee.innerHTML = '<option value="all">Tất cả nhân viên</option>';
                
                // Add employees to dropdowns
                employees.forEach(employee => {
                    const option1 = document.createElement('option');
                    option1.value = employee.id;
                    option1.textContent = employee.name;
                    
                    const option2 = document.createElement('option');
                    option2.value = employee.id;
                    option2.textContent = employee.name;
                    
                    const option3 = document.createElement('option');
                    option3.value = employee.id;
                    option3.textContent = employee.name;
                    
                    checkInEmployee.appendChild(option1);
                    checkOutEmployee.appendChild(option2);
                    exportEmployee.appendChild(option3);
                });
                
                // Update language for dropdowns if needed
                if (currentLanguage !== 'vi') {
                    changeLanguage(currentLanguage);
                }
            }
            
            // Populate employees table
            function populateEmployeesTable() {
                const tbody = employeesTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                employees.forEach(employee => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${employee.id}</td>
                        <td>${employee.name}</td>
                        <td>${employee.position || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-employee" data-id="${employee.id}">
                                <i class="fas fa-trash"></i> ${translations[currentLanguage]['delete']}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-employee').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteEmployee(id);
                    });
                });
            }
            
            // Populate attendance table
            function populateAttendanceTable() {
                const tbody = attendanceTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                endDate.setHours(23, 59, 59); // Include the entire end date
                
                const selectedEmployee = exportEmployee.value;
                
                const filteredAttendance = attendance.filter(record => {
                    const recordDate = new Date(record.date);
                    const employeeMatch = selectedEmployee === 'all' || record.employeeId === selectedEmployee;
                    return recordDate >= startDate && recordDate <= endDate && employeeMatch;
                });
                
                filteredAttendance.forEach(record => {
                    const employee = employees.find(e => e.id === record.employeeId);
                    const row = document.createElement('tr');
                    
                    // Calculate working hours
                    let workingHours = translations[currentLanguage]['not-checked-out'];
                    if (record.checkIn && record.checkOut) {
                        const checkInTime = new Date(record.date + 'T' + record.checkIn);
                        const checkOutTime = new Date(record.date + 'T' + record.checkOut);
                        const diffMs = checkOutTime - checkInTime;
                        const diffHrs = Math.floor(diffMs / 3600000);
                        const diffMins = Math.round((diffMs % 3600000) / 60000);
                        workingHours = `${diffHrs} giờ ${diffMins} phút`;
                    }
                    
                    row.innerHTML = `
                        <td>${new Date(record.date).toLocaleDateString('vi-VN')}</td>
                        <td>${employee ? employee.name : 'Unknown'}</td>
                        <td>${employee ? (employee.position || '') : ''}</td>
                        <td>${record.checkIn || translations[currentLanguage]['not-checked-in']}</td>
                        <td>${record.checkOut || translations[currentLanguage]['not-checked-out']}</td>
                        <td>${workingHours}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Add new employee to Firestore
            function addEmployee() {
                if (!isAdmin) {
                    alert('Bạn cần xác thực quyền admin trước');
                    return;
                }
                
                const name = employeeNameInput.value.trim();
                const position = employeePositionInput.value.trim();
                
                if (!name) {
                    alert('Vui lòng nhập tên nhân viên');
                    return;
                }
                
                showLoading();
                
                // Thêm nhân viên vào Firestore
                db.collection('employees').add({
                    name: name,
                    position: position,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    employeeNameInput.value = '';
                    employeePositionInput.value = '';
                    hideLoading();
                    alert(`Đã thêm nhân viên: ${name}`);
                })
                .catch(error => {
                    console.error('Error adding employee:', error);
                    alert(translations[currentLanguage]['connection-error']);
                    hideLoading();
                });
            }
            
            // Delete employee from Firestore
            function deleteEmployee(id) {
                if (!isAdmin) {
                    alert('Bạn cần xác thực quyền admin trước');
                    return;
                }
                
                if (!confirm('Bạn có chắc chắn muốn xóa nhân viên này?')) {
                    return;
                }
                
                showLoading();
                
                db.collection('employees').doc(id).delete()
                .then(() => {
                    hideLoading();
                    alert('Đã xóa nhân viên');
                })
                .catch(error => {
                    console.error('Error deleting employee:', error);
                    alert(translations[currentLanguage]['connection-error']);
                    hideLoading();
                });
            }
            
            // Clear attendance data from Firestore
            function clearAttendanceData() {
                if (!isAdmin) {
                    alert('Bạn cần xác thực quyền admin trước');
                    return;
                }
                
                if (!confirm(translations[currentLanguage]['clear-data-confirm'])) {
                    return;
                }
                
                showLoading();
                
                // Xóa tất cả dữ liệu chấm công
                const batch = db.batch();
                const attendanceRef = db.collection('attendance');
                
                // Lấy tất cả documents và xóa
                attendanceRef.get().then(snapshot => {
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    hideLoading();
                    alert(translations[currentLanguage]['data-cleared']);
                })
                .catch(error => {
                    console.error('Error clearing attendance data:', error);
                    alert(translations[currentLanguage]['connection-error']);
                    hideLoading();
                });
            }
            
            // Check in employee
            function checkIn() {
                const employeeId = checkInEmployee.value;
                
                if (!employeeId || employeeId === '-- Chọn nhân viên --') {
                    alert('Vui lòng chọn nhân viên');
                    return;
                }
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toLocaleTimeString('vi-VN');
                
                showLoading();
                
                // Kiểm tra xem đã chấm công vào chưa
                db.collection('attendance')
                    .where('employeeId', '==', employeeId)
                    .where('date', '==', dateStr)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            hideLoading();
                            alert('Nhân viên này đã chấm công vào hôm nay');
                            return;
                        }
                        
                        // Thêm bản ghi chấm công vào
                        return db.collection('attendance').add({
                            employeeId: employeeId,
                            date: dateStr,
                            checkIn: timeStr,
                            checkOut: null,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    })
                    .then(() => {
                        hideLoading();
                        alert('Đã chấm công vào');
                        checkInEmployee.value = '-- Chọn nhân viên --';
                    })
                    .catch(error => {
                        console.error('Error checking in:', error);
                        alert(translations[currentLanguage]['connection-error']);
                        hideLoading();
                    });
            }
            
            // Check out employee
            function checkOut() {
                const employeeId = checkOutEmployee.value;
                
                if (!employeeId || employeeId === '-- Chọn nhân viên --') {
                    alert('Vui lòng chọn nhân viên');
                    return;
                }
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toLocaleTimeString('vi-VN');
                
                showLoading();
                
                // Tìm bản ghi chấm công vào
                db.collection('attendance')
                    .where('employeeId', '==', employeeId)
                    .where('date', '==', dateStr)
                    .get()
                    .then(snapshot => {
                        if (snapshot.empty) {
                            hideLoading();
                            alert('Nhân viên này chưa chấm công vào hôm nay');
                            return;
                        }
                        
                        const record = snapshot.docs[0];
                        const data = record.data();
                        
                        if (data.checkOut) {
                            hideLoading();
                            alert('Nhân viên này đã chấm công ra hôm nay');
                            return;
                        }
                        
                        // Cập nhật bản ghi với thời gian ra
                        return db.collection('attendance').doc(record.id).update({
                            checkOut: timeStr,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    })
                    .then(() => {
                        hideLoading();
                        alert('Đã chấm công ra');
                        checkOutEmployee.value = '-- Chọn nhân viên --';
                    })
                    .catch(error => {
                        console.error('Error checking out:', error);
                        alert(translations[currentLanguage]['connection-error']);
                        hideLoading();
                    });
            }
            
            // Export to Excel
            function exportToExcel() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                endDate.setHours(23, 59, 59); // Include the entire end date
                
                const selectedEmployee = exportEmployee.value;
                
                const filteredAttendance = attendance.filter(record => {
                    const recordDate = new Date(record.date);
                    const employeeMatch = selectedEmployee === 'all' || record.employeeId === selectedEmployee;
                    return recordDate >= startDate && recordDate <= endDate && employeeMatch;
                });
                
                if (filteredAttendance.length === 0) {
                    alert('Không có dữ liệu để xuất');
                    return;
                }
                
                // Prepare data for Excel
                const data = filteredAttendance.map(record => {
                    const employee = employees.find(e => e.id === record.employeeId);
                    
                    // Calculate working hours
                    let workingHours = 'Chưa chấm ra';
                    if (record.checkIn && record.checkOut) {
                        const checkInTime = new Date(record.date + 'T' + record.checkIn);
                        const checkOutTime = new Date(record.date + 'T' + record.checkOut);
                        const diffMs = checkOutTime - checkInTime;
                        const diffHrs = Math.floor(diffMs / 3600000);
                        const diffMins = Math.round((diffMs % 3600000) / 60000);
                        workingHours = `${diffHrs} giờ ${diffMins} phút`;
                    }
                    
                    return {
                        'Ngày': new Date(record.date).toLocaleDateString('vi-VN'),
                        'Nhân viên': employee ? employee.name : 'Unknown',
                        'Chức vụ': employee ? (employee.position || '') : '',
                        'Giờ vào': record.checkIn || 'Chưa chấm',
                        'Giờ ra': record.checkOut || 'Chưa chấm ra',
                        'Thời gian làm việc': workingHours
                    };
                });
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(data);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Chấm công');
                
                // Generate Excel file
                const fileName = `Bao_cao_cham_cong_${startDateInput.value}_den_${endDateInput.value}.xlsx`;
                XLSX.writeFile(wb, fileName);
            }
            
            // Verify admin code
            function verifyAdmin() {
                const code = adminCodeInput.value;
                // Simple admin code check - in a real app, use proper authentication
                if (code === '123456') {
                    isAdmin = true;
                    adminFeatures.classList.remove('d-none');
                    alert('Đã xác thực quyền admin');
                } else {
                    alert('Mã admin không đúng');
                }
            }
            
            // Event Listeners
            adminToggle.addEventListener('click', function() {
                adminSection.classList.toggle('d-none');
            });
            
            verifyAdminBtn.addEventListener('click', verifyAdmin);
            
            addEmployeeBtn.addEventListener('click', addEmployee);
            
            checkInBtn.addEventListener('click', checkIn);
            
            checkOutBtn.addEventListener('click', checkOut);
            
            exportBtn.addEventListener('click', exportToExcel);
            
            clearDataBtn.addEventListener('click', clearAttendanceData);
            
            startDateInput.addEventListener('change', populateAttendanceTable);
            endDateInput.addEventListener('change', populateAttendanceTable);
            exportEmployee.addEventListener('change', populateAttendanceTable);
            
            languageLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const lang = this.getAttribute('data-lang');
                    changeLanguage(lang);
                });
            });
            
            // Initialize the application
            loadEmployees();
            loadAttendance();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>