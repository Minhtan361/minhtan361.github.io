<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- Favicon chuẩn (bắt buộc) -->
<link rel="icon" href="https://minhtan361.github.io/logo/favicon.ico" type="image/x-icon">

<!-- PNG favicon nhiều kích thước -->
<link rel="icon" type="image/png" sizes="16x16" href="https://minhtan361.github.io/logo/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://minhtan361.github.io/logo/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="57x57" href="https://minhtan361.github.io/logo/favicon-57x57.png">
<link rel="icon" type="image/png" sizes="60x60" href="https://minhtan361.github.io/logo/favicon-60x60.png">
<link rel="icon" type="image/png" sizes="72x72" href="https://minhtan361.github.io/logo/favicon-72x72.png">
<link rel="icon" type="image/png" sizes="76x76" href="https://minhtan361.github.io/logo/favicon-76x76.png">
<link rel="icon" type="image/png" sizes="96x96" href="https://minhtan361.github.io/logo/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="114x114" href="https://minhtan361.github.io/logo/favicon-114x114.png">
<link rel="icon" type="image/png" sizes="120x120" href="https://minhtan361.github.io/logo/favicon-120x120.png">
<link rel="icon" type="image/png" sizes="144x144" href="https://minhtan361.github.io/logo/favicon-144x144.png">
<link rel="icon" type="image/png" sizes="152x152" href="https://minhtan361.github.io/logo/favicon-152x152.png">
<link rel="icon" type="image/png" sizes="180x180" href="https://minhtan361.github.io/logo/favicon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://minhtan361.github.io/logo/favicon-192x192.png">
<link rel="icon" type="image/png" sizes="256x256" href="https://minhtan361.github.io/logo/favicon-256x256.png">
<link rel="icon" type="image/png" sizes="384x384" href="https://minhtan361.github.io/logo/favicon-384x384.png">
<link rel="icon" type="image/png" sizes="512x512" href="https://minhtan361.github.io/logo/favicon-512x512.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chấm Công Thai Thae - minhtan361</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Thư viện mới để chụp ảnh HTML và tạo file ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- THÊM MỚI: Thư viện cho hiệu ứng nền 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
    /* Nâng cấp giao diện hiện đại */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
        --primary-color: #00695c;
        --secondary-color: #3949ab;
        --success-color: #43a047;
        --danger-color: #e53935;
        --warning-color: #fbc02d;
        --bg-body: #e3e5e9;
        --card-shadow: 0 8px 20px rgba(0,0,0,0.08);
        --radius: 16px;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: transparent; /* Nền trong suốt để thấy hiệu ứng 3D */
        color: #333;
    }

    /* THÊM MỚI: CSS cho nền 3D */
    #vanta-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Đặt canvas nằm dưới cùng */
    }

    /* Navbar */
    .navbar {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .navbar-brand {
        font-weight: 700;
        font-size: 1.2rem;
        color: #fff !important;
    }
    .navbar-nav .nav-link {
        color: rgba(255,255,255,0.8);
    }
    .navbar-nav .nav-link:hover {
        color: #fff;
    }
    .navbar .btn {
        border-radius: 50px;
        font-weight: 600;
    }

    /* Card */
    .card {
        /* NÂNG CẤP: Hiệu ứng thủy tinh mờ (Glassmorphism) */
        background: rgba(255, 255, 255, 0.65);
        -webkit-backdrop-filter: blur(12px);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius);
        box-shadow: var(--card-shadow);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
        transform: translateY(-4px);
        /* NÂNG CẤP: Đổ bóng nhẹ hơn cho hiệu ứng thủy tinh */
        box-shadow: 0 12px 25px rgba(0,0,0,0.08);
    }
    .card-header {
        font-weight: 600;
        border-radius: var(--radius) var(--radius) 0 0 !important;
    }

    /* Clock */
    .clock-display {
        font-size: 3rem;
        font-weight: 600;
        color: var(--secondary-color);
        letter-spacing: -1px;
    }

    /* Buttons */
    .btn {
        border-radius: 12px;
        font-weight: 600;
        padding: 0.6rem 1rem;
        transition: all 0.2s ease-in-out;
    }
    .btn-primary {
        background: var(--primary-color);
        border: none;
    }
    .btn-primary:hover {
        background: #004d40;
    }
    .btn-success:hover { background: #2e7d32; }
    .btn-danger:hover { background: #c62828; }
    .btn-outline-secondary:hover {
        background: #eceff1;
    }

    /* Tables */
    .table {
        border-radius: var(--radius);
        overflow: hidden;
    }
    .table thead {
        background-color: var(--secondary-color);
        color: #fff;
        font-weight: 600;
    }
    .table td, .table th {
        padding: 0.9rem 0.75rem; /* Tăng padding cho dễ đọc */
        vertical-align: middle;
    }
    .table-striped>tbody>tr:nth-of-type(odd)>* {
        background-color: rgba(255, 255, 255, 0.5);
    }

    /* Payslip */
    .payslip {
        border-radius: var(--radius);
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        padding: 25px;
        background: #fff;
        border: 1px solid #eee;
    }
    .payslip h4, .payslip h5 {
        color: var(--primary-color);
        font-weight: 700;
    }
    .summary-row {
        background: #e8f5e9;
        font-weight: 700;
    }

    /* Tabs */
    .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
        font-weight: 600;
    }
    .nav-tabs .nav-link.active {
        background-color: var(--primary-color);
        color: #fff;
    }

    /* Inputs */
    .form-control, .form-select {
        border-radius: 10px;
        border: 1px solid #ddd;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.2rem rgba(63,81,181,0.25);
    }

    /* NÂNG CẤP: Modal */
    .modal-content {
        background: rgba(255, 255, 255, 0.8);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius);
    }
    .modal-header {
        border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .modal-footer {
        background-color: rgba(248, 249, 250, 0.7);
        border-top: 1px solid rgba(0,0,0,0.08);
        border-radius: 0 0 var(--radius) var(--radius);
    }

    /* Custom styles for new features */
    .attendance-history-panel {
        display: none;
    }

    /* Language Switcher */
    .dropdown-item img {
        width: 20px;
        margin-right: 8px;
    }
    .dropdown-menu {
        border-radius: 12px;
    }
    </style>
</head>

<body>
    <!-- THÊM MỚI: Vùng chứa cho hiệu ứng nền 3D -->
    <div id="vanta-bg"></div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-business-time me-2"></i><span data-lang-key="app_title">Chấm Công Thai Thae - minhtan361</span></a>
            <div class="d-flex align-items-center">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-globe"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('vi')"><img src="https://cdn-icons-png.flaticon.com/512/555/555515.png" alt="VN"> Tiếng Việt</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('en')"><img src="https://cdn-icons-png.flaticon.com/512/555/555417.png" alt="EN"> English</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setLanguage('th')"><img src="https://cdn-icons-png.flaticon.com/512/555/555416.png" alt="TH"> ภาษาไทย</a></li>
                    </ul>
                </div>
                <button class="btn btn-outline-light" id="adminToggle"><i class="fas fa-user-shield me-1"></i><span data-lang-key="admin_mode">Chế độ Admin</span></button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="loading" id="loadingIndicator"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Đang tải dữ liệu...</p></div>

        <div class="row">
            <div class="col-md-5"> 
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted" data-lang-key="current_time">Thời gian hiện tại</h5>
                        <div class="clock-display" id="currentTime">00:00:00</div>
                        <div id="currentDate" class="text-secondary fw-light"></div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white"><h5 class="mb-0"><i class="fas fa-fingerprint me-2"></i><span data-lang-key="attendance_area">Khu vực Chấm công</span></h5></div>
                    <div class="card-body">
                        <div id="loginArea">
                            <h6 class="mb-3 text-secondary" data-lang-key="login_prompt">Đăng nhập để Chấm công</h6>
                            <div class="row g-3 align-items-end">
                                <div class="col-12"><label class="small" data-lang-key="username">Username</label><input class="form-control" id="loginUsername" data-lang-placeholder="username_placeholder"></div>
                                <div class="col-12"><label class="small" data-lang-key="password">Mật khẩu</label><input type="password" class="form-control" id="loginPassword" data-lang-placeholder="password_placeholder"></div>
                                <div class="col-12 d-flex gap-2">
                                    <button class="btn btn-primary w-100" id="loginBtn"><span data-lang-key="login">Đăng nhập</span></button>
                                    <button class="btn btn-outline-secondary w-100" id="loginByIdBtn"><span data-lang-key="login_by_id">Đăng nhập bằng ID</span></button>
                                </div>
                            </div>
                            <div class="mt-3" id="loginMessage"></div>
                        </div>

                        <div id="clockingArea" class="d-none text-center">
                            <h4 class="mb-3"><span data-lang-key="hello">Xin chào</span>, <strong id="loggedName" class="text-primary"></strong> (<span id="loggedPosition"></span>)</h4>
                            <p class="text-danger small"><span data-lang-key="default_shift">Ca làm mặc định</span>: <strong id="loggedShift"></strong></p>

                            <div class="mb-3 text-start">
                                <label for="shiftSelect" class="form-label small fw-bold"><i class="fas fa-calendar-check me-1"></i><span data-lang-key="step1_shift">1. Chọn ca làm hôm nay:</span></label>
                                <select class="form-select" id="shiftSelect"></select>
                            </div>
                            <div class="mb-3 text-start">
                                <label for="lateReason" class="form-label small fw-bold"><i class="fas fa-pencil-alt me-1"></i><span data-lang-key="step2_late_reason">2. Xin phép đi muộn (Ghi trước khi chấm công vào và giới hạn 2 lần/tuần):</span></label>
                                <textarea class="form-control" id="lateReason" rows="1" data-lang-placeholder="late_reason_placeholder"></textarea>
                                <small class="text-muted" data-lang-key="late_reason_note">Ghi chú này sẽ loại bỏ phạt đi trễ 10.000 VND nếu bạn chấm công muộn. <span id="lateNotesRemaining"></span></small>
                                <button class="btn btn-warning btn-sm w-100 mt-2" id="submitLateRequestBtn"><i class="fas fa-paper-plane me-2"></i><span data-lang-key="send_request">Gửi yêu cầu</span></button> 
                            </div>

                            <div class="clocking-buttons d-flex gap-3 justify-content-center">
                                <button class="btn btn-success btn-lg w-50" id="checkInBtn"><i class="fas fa-sign-in-alt me-2"></i><span data-lang-key="check_in">Vào</span></button>
                                <button class="btn btn-danger btn-lg w-50" id="checkOutBtn"><i class="fas fa-sign-out-alt me-2"></i><span data-lang-key="check_out">Ra</span></button>
                            </div>
                            <div class="mt-3"><button class="btn btn-secondary btn-sm" id="logoutBtn"><span data-lang-key="logout">Thoát phiên</span></button></div>
                            <p class="mt-2 small text-muted" data-lang-key="session_info">Phiên đăng nhập còn hiệu lực 361</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-7" id="adminDashboardPanel" style="display:none;">
                <div class="card">
                    <div class="card-header bg-secondary-color text-white" style="background-color: var(--secondary-color) !important;">
                        <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i><span data-lang-key="admin_dashboard">Bảng Điều Khiển Quản Trị</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="admin-verification-area mb-4" id="adminVerificationArea">
                            <h6 class="mb-3 text-primary"><i class="fas fa-lock me-2"></i><span data-lang-key="verify_admin_title">Xác minh Admin</span></h6>
                            <div class="input-group">
                                <input type="password" class="form-control" id="adminCode" data-lang-placeholder="admin_code_placeholder">
                                <button class="btn btn-primary" id="verifyAdmin"><i class="fas fa-check me-1"></i><span data-lang-key="confirm">Xác nhận</span></button>
                            </div>
                        </div>

                        <div class="admin-tabs d-none" id="adminFeatures">
                            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                                <li class="nav-item"><button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-content" type="button"><i class="fas fa-table me-1"></i><span data-lang-key="tab_data_payroll">1. Dữ liệu & Tính lương</span></button></li>
                                <li class="nav-item"><button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-content" type="button"><i class="fas fa-cogs me-1"></i><span data-lang-key="tab_settings_employee">2. Cài đặt & Nhân viên</span></button></li>
                            </ul>
                            <div class="tab-content pt-3" id="adminTabsContent">
                                
                                <div class="tab-pane fade show active" id="data-content" role="tabpanel">
                                    <h6 class="text-primary mb-3"><i class="fas fa-filter me-1"></i><span data-lang-key="data_filter">Bộ lọc Dữ liệu</span></h6>
                                    <div class="row mb-3 g-3 align-items-end">
                                        <div class="col-md-2"><label class="small" data-lang-key="from_date">Từ ngày</label><input type="date" class="form-control" id="startDate"></div>
                                        <div class="col-md-2"><label class="small" data-lang-key="to_date">Đến ngày</label><input type="date" class="form-control" id="endDate"></div>
                                        <div class="col-md-3"><label class="small" data-lang-key="position">Chức vụ</label><select class="form-select" id="exportPosition"><option value="all" data-lang-key="all_positions">Tất cả</option></select></div>
                                        <div class="col-md-3"><label class="small" data-lang-key="employee">Nhân viên</label><select class="form-select" id="exportEmployee"><option value="all" data-lang-key="all_employees">Tất cả</option></select></div>
                                        <div class="col-md-2">
                                            <button class="btn btn-info w-100" id="applyFilterBtn"><i class="fas fa-filter me-2"></i><span data-lang-key="apply">Áp dụng</span></button>
                                        </div>
                                    </div>
                                    <h5 class="mt-4 text-primary"><i class="fas fa-table me-2"></i><span data-lang-key="attendance_data">Dữ liệu Chấm công</span></h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-sm small" id="attendanceTable"><thead><tr><th data-lang-key="col_date">Ngày</th><th data-lang-key="col_employee">Nhân viên</th><th data-lang-key="col_shift">Ca</th><th data-lang-key="col_checkin">Giờ vào</th><th data-lang-key="col_checkout">Giờ ra</th><th data-lang-key="col_workhours">Giờ làm</th><th data-lang-key="col_status">Trạng thái</th><th data-lang-key="col_notes">Ghi chú/Xin phép</th><th data-lang-key="col_actions">Hành động</th></tr></thead><tbody></tbody></table>
                                    </div>
                                    <button class="btn btn-primary btn-sm w-100" id="exportBtn"><i class="fas fa-file-excel me-2"></i><span data-lang-key="export_attendance_excel">Xuất Excel Dữ liệu Chấm công</span></button>

                                    <div class="mt-4 text-center">
                                        <button class="btn btn-success btn-lg" id="computePayrollBtn"><i class="fas fa-calculator me-2"></i><span data-lang-key="calculate_payroll">TÍNH LƯƠNG</span></button>
                                        <button class="btn btn-primary btn-lg d-none" id="printPayrollBtn"><i class="fas fa-print me-2"></i><span data-lang-key="print_export_payroll">IN/XUẤT BẢNG LƯƠNG</span></button>
                                    </div>

                                    <div class="mt-4" id="payrollResultArea" style="display:none">
                                        <h5 class="text-success"><i class="fas fa-money-check-alt me-2"></i><span data-lang-key="detailed_payroll">Bảng lương chi tiết</span></h5>
                                        <div id="payrollResult"></div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="settings-content" role="tabpanel">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-users-cog me-1"></i><span data-lang-key="employee_management">Quản lý nhân viên</span></h5>
                                    <p class="text-danger small" data-lang-key="add_employee_note">* Khi tạo nhân viên hệ thống tự tạo username và mật khẩu mặc định: <strong>thaithae</strong></p>

                                    <div class="row mb-3 g-2 align-items-end">
                                        <div class="col-md-3"><label class="small" data-lang-key="employee_name">Tên nhân viên</label><input type="text" class="form-control" id="employeeName" data-lang-placeholder="employee_name_placeholder"></div>
                                        <div class="col-md-3"><label class="small" data-lang-key="position">Chức vụ</label><input type="text" class="form-control" id="employeePosition" data-lang-placeholder="position_placeholder"></div>
                                        <div class="col-md-2"><label class="small" data-lang-key="base_salary">Lương cơ bản</label><input type="number" class="form-control" id="employeeBaseSalary" data-lang-placeholder="salary_placeholder"></div>
                                        <div class="col-md-2"><label class="small" data-lang-key="default_shift">Ca mặc định</label>
                                            <select class="form-select" id="employeeShift">
                                                <option value="shift1">Ca 1</option><option value="shift2">Ca 2</option><option value="shift3">Ca 3</option>
                                                <option value="shift4">Ca 4</option><option value="shift5">Ca 5</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-success w-100" id="addEmployee"><i class="fas fa-user-plus"></i> <span data-lang-key="add">Thêm</span></button>
                                        </div>
                                    </div>

                                    <div class="table-responsive mb-4">
                                        <table class="table table-striped table-hover small" id="employeesTable">
                                            <thead class="bg-light"><tr><th data-lang-key="col_id">ID</th><th data-lang-key="col_name">Tên</th><th data-lang-key="col_username">Username</th><th data-lang-key="col_position">Chức vụ</th><th data-lang-key="col_default_shift">Ca mặc định</th><th data-lang-key="col_base_salary">Lương cơ bản</th><th data-lang-key="col_actions">Hành động</th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>

                                    <h5 class="mt-4 text-primary"><i class="fas fa-sliders-h me-1"></i><span data-lang-key="payroll_settings">Cài đặt tính lương</span></h5>
                                    <div class="row mb-3 g-2">
                                        <div class="col-md-4"><label class="small" data-lang-key="wage_per_hour">Lương theo giờ (VND)</label><input type="number" id="wagePerHour" class="form-control" data-lang-placeholder="wage_per_hour_placeholder"></div>
                                        <div class="col-md-4"><label class="small" data-lang-key="default_bonus">Thưởng mặc định (VND)</label><input type="number" id="defaultBonus" class="form-control" data-lang-placeholder="default_bonus_placeholder"></div>
                                        <div class="col-md-4"><label class="small" data-lang-key="default_penalty">Phạt chung (VND)</label><input type="number" id="defaultPenalty" class="form-control" data-lang-placeholder="default_penalty_placeholder"></div>
                                    </div>
                                    <div class="row mb-3 g-2">
                                        <div class="col-md-4"><label class="small" data-lang-key="late_penalty">Phạt đi muộn (VND)</label><input type="number" id="latePenalty" class="form-control" data-lang-placeholder="late_penalty_placeholder"></div>
                                        <div class="col-md-4"><label class="small" data-lang-key="edit_penalty">Phạt sửa/quên công (VND)</label><input type="number" id="editPenalty" class="form-control" data-lang-placeholder="edit_penalty_placeholder"></div>
                                        <div class="col-md-4"><label class="small" data-lang-key="forgot_checkout_penalty">Phạt quên chấm ra (VND)</label><input type="number" id="forgotOutPenalty" class="form-control" data-lang-placeholder="forgot_checkout_penalty_placeholder"></div>
                                    </div>
                                    <div class="row mb-3 g-2">
                                        <div class="col-12"><label class="small" data-lang-key="wifi_ip_config">Minhtan config:</label><input type="text" class="form-control" id="wifiIpAddress" data-lang-placeholder="wifi_ip_placeholder"></div>
                                    </div>

                                    <h5 class="mt-4 text-primary"><i class="fas fa-calendar-alt me-1"></i><span data-lang-key="holiday_list">Danh sách ngày lễ (Lương x2)</span></h5>
                                    <div class="row mb-3 g-2">
                                        <div class="col-md-8"><input type="text" id="holidayList" class="form-control" rows="1" data-lang-placeholder="holiday_list_placeholder"></div>
                                        <div class="col-md-4 d-flex align-items-end"><button class="btn btn-primary w-100" id="saveSettings"><span data-lang-key="save_general_settings">Lưu Cài đặt Chung</span></button></div>
                                    </div>
                                    <p class="small text-muted" id="currentHolidays"></p>

                                    <h5 class="mt-4 text-primary"><i class="fas fa-tools me-1"></i><span data-lang-key="maintenance_actions">Thao tác bảo trì</span></h5>
                                    <div class="row mt-3 g-2">
                                        <div class="col-md-6"><button class="btn btn-danger w-100" id="clearDataBtn"><i class="fas fa-trash me-1"></i><span data-lang-key="delete_attendance_data">Xóa dữ liệu chấm công</span></button></div>
                                        <div class="col-md-6"><button class="btn btn-secondary w-100" id="forceLogoutAll"><i class="fas fa-sign-out-alt me-1"></i><span data-lang-key="force_logout_all">Đăng xuất tất cả phiên</span></button></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-7 attendance-history-panel" id="personalAttendancePanel">
                <div class="card">
                    <div class="card-header bg-secondary-color text-white" style="background-color: var(--secondary-color) !important;">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i><span data-lang-key="your_attendance_history">Lịch sử Chấm công của bạn</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm small" id="personalAttendanceTable">
                                <thead>
                                    <tr>
                                        <th data-lang-key="col_date">Ngày</th>
                                        <th data-lang-key="col_shift">Ca</th>
                                        <th data-lang-key="col_checkin">Giờ vào</th>
                                        <th data-lang-key="col_checkout">Giờ ra</th>
                                        <th data-lang-key="col_workhours">Giờ làm</th>
                                        <th data-lang-key="col_status">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="printExportModal" tabindex="-1" aria-labelledby="printExportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="printExportModalLabel" data-lang-key="print_export_payroll">In / Xuất Bảng Lương</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="payslipContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-lang-key="close">Đóng</button>
                    <button type="button" class="btn btn-primary" id="downloadPayslipsZipBtn"><i class="fas fa-file-archive"></i> <span data-lang-key="download_zip">Tải về ảnh PNG (ZIP)</span></button>
                    <button type="button" class="btn btn-success" id="exportPayslipExcelBtn"><i class="fas fa-file-excel"></i> <span data-lang-key="export_summary_excel">Xuất Bảng lương Tổng hợp Excel</span></button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD3LxaZzvFsbtzA4VRYjVWvIOdqgyNYO2o",
      authDomain: "quan-ly-cham-cong-105da.firebaseapp.com",
      projectId: "quan-ly-cham-cong-105da",
      storageBucket: "quan-ly-cham-cong-105da.firebasestorage.app",
      messagingSenderId: "226837876955",
      appId: "1:226837876955:web:883453c0b19b25098bbcfe",
      measurementId: "G-KLZTCZF14B"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // SỬA LỖI: Di chuyển khối ngôn ngữ vào đây
    const translations = {
        'vi': {
            "app_title": "Chấm Công Thai Thae - minhtan361", "admin_mode": "Chế độ Admin", "current_time": "Thời gian hiện tại", "attendance_area": "Khu vực Chấm công",
            "login_prompt": "Đăng nhập để Chấm công", "username": "Username", "password": "Mật khẩu", "login": "Đăng nhập", "login_by_id": "Đăng nhập bằng ID",
            "username_placeholder": "ví dụ: quynhanh, phuoclong,...", "password_placeholder": "mật khẩu: thaithae",
            "hello": "Xin chào", "default_shift": "Ca làm mặc định", "step1_shift": "1. Chọn ca làm hôm nay:", "step2_late_reason": "2. Xin phép đi muộn (Ghi trước khi chấm công vào và giới hạn 2 lần/tuần):",
            "late_reason_placeholder": "Em xin đi muộn 30p do bận việc...", "late_reason_note": "Ghi chú này sẽ loại bỏ phạt đi trễ 10.000 VND nếu bạn chấm công muộn.",
            "send_request": "Gửi yêu cầu", "check_in": "Vào", "check_out": "Ra", "logout": "Thoát phiên", "session_info": "Phiên đăng nhập còn hiệu lực 361",
            "admin_dashboard": "Bảng Điều Khiển Quản Trị", "verify_admin_title": "Xác minh Admin", "admin_code_placeholder": "Nhập mã khóa admin", "confirm": "Xác nhận",
            "tab_data_payroll": "1. Dữ liệu & Tính lương", "tab_settings_employee": "2. Cài đặt & Nhân viên", "data_filter": "Bộ lọc Dữ liệu",
            "from_date": "Từ ngày", "to_date": "Đến ngày", "position": "Chức vụ", "employee": "Nhân viên", "all_positions": "Tất cả chức vụ", "all_employees": "Tất cả nhân viên",
            "apply": "Áp dụng", "attendance_data": "Dữ liệu Chấm công", "col_date": "Ngày", "col_employee": "Nhân viên", "col_shift": "Ca", "col_checkin": "Giờ vào", "col_checkout": "Giờ ra", "col_workhours": "Giờ làm", "col_status": "Trạng thái", "col_notes": "Ghi chú/Xin phép", "col_actions": "Hành động",
            "export_attendance_excel": "Xuất Excel Dữ liệu Chấm công", "calculate_payroll": "TÍNH LƯƠNG", "print_export_payroll": "IN/XUẤT BẢNG LƯƠNG", "detailed_payroll": "Bảng lương chi tiết",
            "employee_management": "Quản lý nhân viên", "add_employee_note": "* Khi tạo nhân viên hệ thống tự tạo username và mật khẩu mặc định: thaithae",
            "employee_name": "Tên nhân viên", "employee_name_placeholder": "Tên nhân viên", "position_placeholder": "Chức vụ", "base_salary": "Lương cơ bản", "salary_placeholder": "Lương (VND)",
            "default_shift": "Ca mặc định", "add": "Thêm", "col_id": "ID", "col_name": "Tên", "col_username": "Username", "col_position": "Chức vụ", "col_default_shift": "Ca mặc định", "col_base_salary": "Lương cơ bản",
            "payroll_settings": "Cài đặt tính lương", "wage_per_hour": "Lương theo giờ (VND)", "wage_per_hour_placeholder": "Lương theo giờ (VND)", "default_bonus": "Thưởng mặc định (VND)", "default_bonus_placeholder": "Thưởng mặc định (VND)",
            "default_penalty": "Phạt chung (VND)", "default_penalty_placeholder": "Phạt chung (VND)", "late_penalty": "Phạt đi muộn (VND)", "late_penalty_placeholder": "Phạt 10000",
            "edit_penalty": "Phạt sửa/quên công (VND)", "edit_penalty_placeholder": "Phạt 20000", "forgot_checkout_penalty": "Phạt quên chấm ra (VND)", "forgot_checkout_penalty_placeholder": "Phạt 20000",
            "wifi_ip_config": "Minhtan config:", "wifi_ip_placeholder": "Nhập địa chỉ IP công cộng của quán (ví dụ: 103.111.200.222)",
            "holiday_list": "Danh sách ngày lễ (Lương x2)", "holiday_list_placeholder": "YYYY-MM-DD, cách nhau bằng dấu phẩy hoặc xuống dòng", "save_general_settings": "Lưu Cài đặt Chung",
            "maintenance_actions": "Thao tác bảo trì", "delete_attendance_data": "Xóa dữ liệu chấm công", "force_logout_all": "Đăng xuất tất cả phiên",
            "your_attendance_history": "Lịch sử Chấm công của bạn", "close": "Đóng", "download_zip": "Tải về ảnh PNG (ZIP)", "export_summary_excel": "Xuất Bảng lương Tổng hợp Excel",
            "save": "Lưu", "cancel": "Hủy", "edit": "Sửa", "delete": "Xóa"
        },
        'en': {
            "app_title": "Attendance - Thai Thae - minhtan361", "admin_mode": "Admin Mode", "current_time": "Current Time", "attendance_area": "Attendance Area",
            "login_prompt": "Login to Clock-in", "username": "Username", "password": "Password", "login": "Login", "login_by_id": "Login by ID",
            "username_placeholder": "e.g., quynhanh, phuoclong,...", "password_placeholder": "password: thaithae",
            "hello": "Hello", "default_shift": "Default Shift", "step1_shift": "1. Select today's shift:", "step2_late_reason": "2. Request for being late (Write before clock-in, limit 2/week):",
            "late_reason_placeholder": "I'll be 30 mins late due to...", "late_reason_note": "This note will waive the 10,000 VND late penalty if you clock in late.",
            "send_request": "Send Request", "check_in": "Check-in", "check_out": "Check-out", "logout": "Logout", "session_info": "Session is valid for 361",
            "admin_dashboard": "Admin Dashboard", "verify_admin_title": "Admin Verification", "admin_code_placeholder": "Enter admin key", "confirm": "Confirm",
            "tab_data_payroll": "1. Data & Payroll", "tab_settings_employee": "2. Settings & Employees", "data_filter": "Data Filter",
            "from_date": "From date", "to_date": "To date", "position": "Position", "employee": "Employee", "all_positions": "All Positions", "all_employees": "All Employees",
            "apply": "Apply", "attendance_data": "Attendance Data", "col_date": "Date", "col_employee": "Employee", "col_shift": "Shift", "col_checkin": "Check-in", "col_checkout": "Check-out", "col_workhours": "Work Hours", "col_status": "Status", "col_notes": "Notes/Request", "col_actions": "Actions",
            "export_attendance_excel": "Export Attendance Data to Excel", "calculate_payroll": "CALCULATE PAYROLL", "print_export_payroll": "PRINT/EXPORT PAYROLL", "detailed_payroll": "Detailed Payroll",
            "employee_management": "Employee Management", "add_employee_note": "* When creating an employee, the system auto-creates a username and default password: thaithae",
            "employee_name": "Employee Name", "employee_name_placeholder": "Employee Name", "position_placeholder": "Position", "base_salary": "Base Salary", "salary_placeholder": "Salary (VND)",
            "default_shift": "Default Shift", "add": "Add", "col_id": "ID", "col_name": "Name", "col_username": "Username", "col_position": "Position", "col_default_shift": "Default Shift", "col_base_salary": "Base Salary",
            "payroll_settings": "Payroll Settings", "wage_per_hour": "Wage per hour (VND)", "wage_per_hour_placeholder": "Wage per hour (VND)", "default_bonus": "Default Bonus (VND)", "default_bonus_placeholder": "Default Bonus (VND)",
            "default_penalty": "General Penalty (VND)", "default_penalty_placeholder": "General Penalty (VND)", "late_penalty": "Late Penalty (VND)", "late_penalty_placeholder": "Penalty 10000",
            "edit_penalty": "Edit/Forgot Penalty (VND)", "edit_penalty_placeholder": "Penalty 20000", "forgot_checkout_penalty": "Forgot Check-out Penalty (VND)", "forgot_checkout_penalty_placeholder": "Penalty 20000",
            "wifi_ip_config": "Minhtan config:", "wifi_ip_placeholder": "Enter public IP address of the store (e.g., 103.111.200.222)",
            "holiday_list": "Holiday List (x2 Salary)", "holiday_list_placeholder": "YYYY-MM-DD, separated by comma or new line", "save_general_settings": "Save General Settings",
            "maintenance_actions": "Maintenance Actions", "delete_attendance_data": "Delete Attendance Data", "force_logout_all": "Force Logout All Sessions",
            "your_attendance_history": "Your Attendance History", "close": "Close", "download_zip": "Download as PNG (ZIP)", "export_summary_excel": "Export Payroll Summary to Excel",
            "save": "Save", "cancel": "Cancel", "edit": "Edit", "delete": "Delete"
        },
        'th': {
            "app_title": "เช็คชื่อ - Thai Thae - minhtan361", "admin_mode": "โหมดผู้ดูแล", "current_time": "เวลาปัจจุบัน", "attendance_area": "พื้นที่เช็คชื่อ",
            "login_prompt": "เข้าสู่ระบบเพื่อลงเวลา", "username": "ชื่อผู้ใช้", "password": "รหัสผ่าน", "login": "เข้าสู่ระบบ", "login_by_id": "เข้าสู่ระบบด้วย ID",
            "username_placeholder": "เช่น quynhanh, phuoclong,...", "password_placeholder": "รหัสผ่าน: thaithae",
            "hello": "สวัสดี", "default_shift": "กะเริ่มต้น", "step1_shift": "1. เลือกกะทำงานวันนี้:", "step2_late_reason": "2. ขออนุญาตมาสาย (เขียนก่อนลงเวลาเข้า, จำกัด 2 ครั้ง/สัปดาห์):",
            "late_reason_placeholder": "ฉันจะมาสาย 30 นาทีเพราะ...", "late_reason_note": "บันทึกนี้จะยกเว้นค่าปรับ 10,000 VND หากคุณมาสาย",
            "send_request": "ส่งคำขอ", "check_in": "เข้างาน", "check_out": "ออกงาน", "logout": "ออกจากระบบ", "session_info": "เซสชันใช้งานได้ 361",
            "admin_dashboard": "แดชบอร์ดผู้ดูแล", "verify_admin_title": "ยืนยันตัวตนผู้ดูแล", "admin_code_placeholder": "ป้อนรหัสผู้ดูแล", "confirm": "ยืนยัน",
            "tab_data_payroll": "1. ข้อมูลและบัญชีเงินเดือน", "tab_settings_employee": "2. ตั้งค่าและพนักงาน", "data_filter": "ตัวกรองข้อมูล",
            "from_date": "จากวันที่", "to_date": "ถึงวันที่", "position": "ตำแหน่ง", "employee": "พนักงาน", "all_positions": "ทุกตำแหน่ง", "all_employees": "พนักงานทั้งหมด",
            "apply": "ใช้", "attendance_data": "ข้อมูลการลงเวลา", "col_date": "วันที่", "col_employee": "พนักงาน", "col_shift": "กะ", "col_checkin": "เวลาเข้า", "col_checkout": "เวลาออก", "col_workhours": "ชั่วโมงทำงาน", "col_status": "สถานะ", "col_notes": "หมายเหตุ/คำขอ", "col_actions": "การกระทำ",
            "export_attendance_excel": "ส่งออกข้อมูลการลงเวลาเป็น Excel", "calculate_payroll": "คำนวณเงินเดือน", "print_export_payroll": "พิมพ์/ส่งออกสลิปเงินเดือน", "detailed_payroll": "รายละเอียดเงินเดือน",
            "employee_management": "การจัดการพนักงาน", "add_employee_note": "* เมื่อสร้างพนักงาน ระบบจะสร้างชื่อผู้ใช้และรหัสผ่านเริ่มต้น: thaithae",
            "employee_name": "ชื่อพนักงาน", "employee_name_placeholder": "ชื่อพนักงาน", "position_placeholder": "ตำแหน่ง", "base_salary": "เงินเดือนพื้นฐาน", "salary_placeholder": "เงินเดือน (VND)",
            "default_shift": "กะเริ่มต้น", "add": "เพิ่ม", "col_id": "ID", "col_name": "ชื่อ", "col_username": "ชื่อผู้ใช้", "col_position": "ตำแหน่ง", "col_default_shift": "กะเริ่มต้น", "col_base_salary": "เงินเดือนพื้นฐาน",
            "payroll_settings": "การตั้งค่าบัญชีเงินเดือน", "wage_per_hour": "ค่าจ้างต่อชั่วโมง (VND)", "wage_per_hour_placeholder": "ค่าจ้างต่อชั่วโมง (VND)", "default_bonus": "โบนัสเริ่มต้น (VND)", "default_bonus_placeholder": "โบนัสเริ่มต้น (VND)",
            "default_penalty": "ค่าปรับทั่วไป (VND)", "default_penalty_placeholder": "ค่าปรับทั่วไป (VND)", "late_penalty": "ค่าปรับมาสาย (VND)", "late_penalty_placeholder": "ค่าปรับ 10000",
            "edit_penalty": "ค่าปรับแก้ไข/ลืม (VND)", "edit_penalty_placeholder": "ค่าปรับ 20000", "forgot_checkout_penalty": "ค่าปรับลืมลงเวลาออก (VND)", "forgot_checkout_penalty_placeholder": "ค่าปรับ 20000",
            "wifi_ip_config": "Minhtan config:", "wifi_ip_placeholder": "ป้อนที่อยู่ IP สาธารณะของร้าน (เช่น 103.111.200.222)",
            "holiday_list": "รายการวันหยุด (เงินเดือน x2)", "holiday_list_placeholder": "YYYY-MM-DD คั่นด้วยจุลภาคหรือขึ้นบรรทัดใหม่", "save_general_settings": "บันทึกการตั้งค่าทั่วไป",
            "maintenance_actions": "การบำรุงรักษา", "delete_attendance_data": "ลบข้อมูลการลงเวลา", "force_logout_all": "บังคับออกจากระบบทุกเซสชัน",
            "your_attendance_history": "ประวัติการลงเวลาของคุณ", "close": "ปิด", "download_zip": "ดาวน์โหลดเป็น PNG (ZIP)", "export_summary_excel": "ส่งออกสรุปเงินเดือนเป็น Excel",
            "save": "บันทึก", "cancel": "ยกเลิก", "edit": "แก้ไข", "delete": "ลบ"
        }
    };

    function setLanguage(lang) {
        localStorage.setItem('language', lang);
        const langData = translations[lang];
        if (!langData) return;

        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (langData[key]) {
                el.textContent = langData[key];
            }
        });

        document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
            const key = el.getAttribute('data-lang-placeholder');
            if (langData[key]) {
                el.placeholder = langData[key];
            }
        });
    }

    // App state
    let employees = [];
    let attendance = [];
    let isAdmin = false;
    let payrollResults = {}; 
    let isEditingAttendance = {};
    let isEditingEmployee = {};
    let loggedInUser = null; 
    
    // UPDATED SETTINGS
    let settings = { wagePerHour: 0, defaultBonus:0, defaultPenalty:0, latePenalty:10000, editPenalty:20000, forgotOutPenalty:20000, holidays: [], wifiIpAddress: '' };
    
    // QUY TẮC GRACE PERIOD 5 PHÚT (Nghiêm ngặt)
    const GRACE_PERIOD_MS = 5 * 60 * 1000; // 5 phút
    const LATE_NOTE_LIMIT = 2; // Giới hạn số lần dùng ghi chú đi muộn mỗi tuần

    // Shift definitions
    const shifts = {
        shift1: { name: 'Ca 1', start: '10:30:00', end: '16:30:00', minutes: 360 }, // 6 hours
        shift2: { name: 'Ca 2', start: '09:00:00', end: '17:00:00', minutes: 480 }, // 8 hours
        shift3: { name: 'Ca 3', start: '17:00:00', end: '23:00:00', minutes: 360 }, // 6 hours
        shift4: { name: 'Ca 4', start: '09:00:00', end: '23:00:00', minutes: 840 }, // 14 hours
        shift5: { name: 'Ca 5', start: '10:30:00', end: '23:00:00', minutes: 750 }  // 12.5 hours
    };

    // DOM 
    const loadingIndicator = document.getElementById('loadingIndicator');
    const employeesTable = document.getElementById('employeesTable').querySelector('tbody');
    const exportEmployee = document.getElementById('exportEmployee');
    const exportPosition = document.getElementById('exportPosition'); 
    const adminDashboardPanel = document.getElementById('adminDashboardPanel'); 
    const adminVerificationArea = document.getElementById('adminVerificationArea');
    const adminFeatures = document.getElementById('adminFeatures');
    const attendanceTableBody = document.getElementById('attendanceTable').querySelector('tbody');
    const payrollResultArea = document.getElementById('payrollResultArea');
    const payrollResult = document.getElementById('payrollResult');
    const printPayrollBtn = document.getElementById('printPayrollBtn');
    const computePayrollBtn = document.getElementById('computePayrollBtn');
    const payslipContainer = document.getElementById('payslipContainer');
    const shiftSelect = document.getElementById('shiftSelect'); 
    const personalAttendancePanel = document.getElementById('personalAttendancePanel');
    const personalAttendanceTableBody = document.getElementById('personalAttendanceTable').querySelector('tbody');
    const lateReasonInput = document.getElementById('lateReason');
    const lateNotesRemainingSpan = document.getElementById('lateNotesRemaining');

    // Session handling
    const SESSION_KEY = 'thai_thae_session';
    const SESSION_DURATION_MS = 4 * 24 * 60 * 60 * 1000; // 4 days

    // Utility functions
    function showLoading(){ loadingIndicator.style.display='block' }
    function hideLoading(){ loadingIndicator.style.display='none' }
    function formatVND(amount){ return Number(amount).toLocaleString('vi-VN') + ' VND'; }
    function updateClock(){ const now = new Date(); document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN'); document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', {weekday:'long', year:'numeric', month:'long', day:'numeric'}); }
    setInterval(updateClock,1000); updateClock();

    function toUsername(name){
        if(!name) return '';
        let s = name.trim().toLowerCase();
        s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        s = s.replace(/[^a-z0-9]/g,'');
        return s;
    }

    // --- CHỨC NĂNG MỚI: KIỂM TRA IP WIFI ---
    async function getPublicIpAddress() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) {
                throw new Error('Không thể lấy địa chỉ IP.');
            }
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error("Lỗi lấy IP:", error);
            return null;
        }
    }

    async function isConnectedToAuthorizedWifi() {
        const publicIp = await getPublicIpAddress();
        if (!publicIp) {
            alert('Không ở quán ai cho chấm công hả. Kết nối wifi của quán đi.');
            return false;
        }

        const authorizedIps = settings.wifiIpAddress.split(',').map(ip => ip.trim());

        if (authorizedIps.includes(publicIp)) {
            return true;
        } else {
            alert(`Tới quán mới chấm công được !!! IP hiện tại : ${publicIp}`);
            return false;
        }
    }

    // --- CHỨC NĂNG MỚI: TẢI VÀ HIỂN THỊ LỊCH SỬ CÁ NHÂN ---
    let unsubscribePersonalAttendance = null;
    function loadPersonalAttendance(employeeId) {
        if (unsubscribePersonalAttendance) unsubscribePersonalAttendance();
        unsubscribePersonalAttendance = db.collection('attendance')
            .where('employeeId', '==', employeeId)
            .orderBy('date', 'desc')
            .onSnapshot(snap => {
                const history = [];
                snap.forEach(doc => history.push({id: doc.id, ...doc.data()}));
                populatePersonalAttendanceUI(history);
            });
    }

    function populatePersonalAttendanceUI(history) {
        personalAttendanceTableBody.innerHTML = '';
        if (history.length === 0) {
            personalAttendanceTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Bạn chưa có lịch sử chấm công nào.</td></tr>';
            return;
        }

        history.forEach(r => {
            const emp = employees.find(x => x.id === r.employeeId) || {};
            const finalShiftKey = r.shiftChosen || emp.shift || 'shift2'; 
            const empShift = shifts[finalShiftKey];

            let checkIn = r.checkIn || '---';
            let finalCheckOut = r.checkOut || '---';
            let hoursText = '0 giờ 0 phút';
            let status = '';

            if (r.checkIn) {
                let inDT = new Date(`${r.date}T${r.checkIn}`);
                let outDT = null;
                if (!r.checkOut) {
                    outDT = new Date(`${r.date}T23:00:00`);
                } else {
                    outDT = new Date(`${r.date}T${r.checkOut}`);
                }
                if (outDT <= inDT) outDT.setDate(outDT.getDate() + 1);
                const diff = Math.max(0, outDT - inDT);
                const hrs = Math.floor(diff / 3600000);
                const mins = Math.round((diff % 3600000) / 60000);
                hoursText = `${hrs} giờ ${mins} phút`;

                const shiftStart = new Date(`${r.date}T${empShift.start}`);
                const isAfterGracePeriod = inDT.getTime() > (shiftStart.getTime() + GRACE_PERIOD_MS);
                
                if (r.edited) {
                    status = 'Sửa công';
                } else if (!r.checkOut) {
                    status = 'Quên chấm ra';
                    finalCheckOut = '23:00:00 (Hệ thống)';
                } else if (r.lateReason) {
                    status = 'Đi muộn (Xin phép)';
                } else if (isAfterGracePeriod) {
                    status = 'Đi muộn (Bị phạt)';
                } else {
                    status = 'Đúng giờ';
                }
            } else {
                status = 'Vắng mặt';
            }

            const isHoliday = settings.holidays && settings.holidays.indexOf(r.date) >= 0;
            if (isHoliday) status += ' / Ngày lễ';

            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${new Date(r.date).toLocaleDateString('vi-VN')}</td>
                            <td>${empShift?.name||'N/A'}</td>
                            <td>${checkIn}</td>
                            <td>${finalCheckOut}</td>
                            <td>${hoursText}</td>
                            <td>${status}</td>`;
            personalAttendanceTableBody.appendChild(tr);
        });
    }

    
    async function checkWeeklyLateNotes(employeeId) {
        const today = new Date();
        const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)));
        firstDayOfWeek.setHours(0, 0, 0, 0);
        
        const q = await db.collection('attendance')
                          .where('employeeId', '==', employeeId)
                          .where('timestamp', '>=', firstDayOfWeek)
                          .get();
        
        let lateNotesUsed = 0;
        q.forEach(doc => {
            if (doc.data().lateReason) {
                lateNotesUsed++;
            }
        });
        
        const remaining = Math.max(0, LATE_NOTE_LIMIT - lateNotesUsed);
        
        if (remaining > 0) {
            lateReasonInput.disabled = false;
            lateNotesRemainingSpan.textContent = `(Còn lại: ${remaining} lượt)`;
        } else {
            lateReasonInput.disabled = true;
            lateReasonInput.value = '';
            lateNotesRemainingSpan.textContent = '(Đã hết lượt xin phép trong tuần)';
        }
    }
    
    // Load employees + attendance from Firestore
    let unsubscribeEmployees=null, unsubscribeAttendance=null;
    function loadEmployees(){ showLoading(); if(unsubscribeEmployees) unsubscribeEmployees(); unsubscribeEmployees = db.collection('employees').onSnapshot(snap=>{ employees=[]; snap.forEach(doc=> employees.push({id:doc.id, ...doc.data()})); populateEmployeesUI(); hideLoading(); tryRestoreSession(); },err=>{ console.error(err); hideLoading(); alert('Lỗi tải nhân viên'); }); }
    function loadAttendance(){ showLoading(); if(unsubscribeAttendance) unsubscribeAttendance(); unsubscribeAttendance = db.collection('attendance').orderBy('date','desc').onSnapshot(snap=>{ attendance=[]; snap.forEach(doc=> attendance.push({id:doc.id, ...doc.data()})); populateAttendanceTable(); hideLoading(); },err=>{ console.error(err); hideLoading(); alert('Lỗi tải chấm công'); }); }

    // Populate Employees UI (Đã thêm tính năng CHỈNH SỬA)
    function populateEmployeesUI(){
        employeesTable.innerHTML='';
        exportEmployee.innerHTML='';
        exportPosition.innerHTML=''; 
        
        let allEmpOpt = document.createElement('option'); allEmpOpt.value='all'; allEmpOpt.textContent='Tất cả nhân viên'; exportEmployee.appendChild(allEmpOpt);
        
        // NEW: Add 'Tất cả chức vụ' option and prepare for unique positions
        let allPosOpt = document.createElement('option'); allPosOpt.value='all'; allPosOpt.textContent='Tất cả chức vụ'; exportPosition.appendChild(allPosOpt);
        const uniquePositions = new Set();
        
        employees.forEach(e=>{
            const isEditing = isEditingEmployee[e.id];
            const shiftName = shifts[e.shift]?.name || e.shift || '';
            const tr = document.createElement('tr');
            tr.id = `emp-row-${e.id}`;

            // Tạo danh sách Option cho Shift (dùng chung cho cả Edit và Display nếu cần)
            const shiftOptions = Object.keys(shifts).map(key => 
                `<option value="${key}" ${e.shift === key ? 'selected' : ''}>${shifts[key].name}</option>`
            ).join('');
            
            if (isEditing) {
                 // Chế độ chỉnh sửa: hiển thị ô nhập liệu
                 tr.innerHTML = `
                    <td>${e.id}</td>
                    <td><input type="text" class="form-control form-control-sm" id="edit-name-${e.id}" value="${e.name}"></td>
                    <td>${e.username||''}</td>
                    <td><input type="text" class="form-control form-control-sm" id="edit-position-${e.id}" value="${e.position||''}"></td>
                    <td>
                        <select class="form-select form-select-sm" id="edit-shift-${e.id}">
                            ${shiftOptions}
                        </select>
                    </td>
                    <td><input type="number" class="form-control form-control-sm" id="edit-salary-${e.id}" value="${e.baseSalary||0}"></td>
                    <td class="d-flex gap-1">
                        <button class="btn btn-sm btn-success btn-save" data-id="${e.id}"><i class="fas fa-save"></i> Lưu</button>
                        <button class="btn btn-sm btn-secondary btn-cancel" data-id="${e.id}"><i class="fas fa-times"></i> Hủy</button>
                    </td>`;
            } else {
                 // Chế độ hiển thị: hiển thị văn bản và nút Sửa/Xóa
                 tr.innerHTML = `
                    <td>${e.id}</td>
                    <td>${e.name}</td>
                    <td>${e.username||''}</td>
                    <td>${e.position||''}</td>
                    <td>${shiftName}</td>
                    <td>${formatVND(e.baseSalary||0)}</td>
                    <td class="d-flex gap-1">
                        <button class="btn btn-sm btn-info btn-edit" data-id="${e.id}"><i class="fas fa-edit"></i> Sửa</button>
                        <button class="btn btn-sm btn-danger btn-delete" data-id="${e.id}"><i class="fas fa-trash"></i> Xóa</button>
                    </td>`;
            }

            employeesTable.appendChild(tr);

            const opt = document.createElement('option'); opt.value = e.id; opt.textContent = e.name; exportEmployee.appendChild(opt);
            
            // NEW: Add position to set
            if (e.position && e.position.trim()) {
                uniquePositions.add(e.position.trim());
            }
        });
        
        // NEW: Populate the exportPosition select field
        uniquePositions.forEach(pos => {
            const opt = document.createElement('option');
            opt.value = pos;
            opt.textContent = pos;
            exportPosition.appendChild(opt);
        });

        // Add event listeners for new buttons
        document.querySelectorAll('.btn-delete').forEach(btn=> btn.addEventListener('click', deleteEmployee));
        document.querySelectorAll('.btn-edit').forEach(btn=> btn.addEventListener('click', editEmployee));
        document.querySelectorAll('.btn-save').forEach(btn=> btn.addEventListener('click', saveEmployee));
        document.querySelectorAll('.btn-cancel').forEach(btn=> btn.addEventListener('click', cancelEdit));
    }
    
    // Logic chỉnh sửa nhân viên 
    function deleteEmployee(event){
        if(!isAdmin){alert('Bạn cần quyền admin');return;} 
        const id=event.currentTarget.getAttribute('data-id'); 
        if(confirm('Xóa nhân viên? Hành động này không thể hoàn tác.')) db.collection('employees').doc(id).delete();
    }

    function editEmployee(event){
        if(!isAdmin){alert('Bạn cần quyền admin');return;} 
        const id=event.currentTarget.getAttribute('data-id');
        // Đặt trạng thái Edit, đảm bảo chỉ 1 người được edit
        isEditingEmployee = {}; 
        isEditingEmployee[id] = true; 
        populateEmployeesUI();
    }

    function cancelEdit(event){
        const id=event.currentTarget.getAttribute('data-id');
        delete isEditingEmployee[id];
        populateEmployeesUI();
    }

    function saveEmployee(event){
        if(!isAdmin){alert('Bạn cần quyền admin');return;} 
        const id=event.currentTarget.getAttribute('data-id');
        const name = document.getElementById(`edit-name-${id}`).value.trim();
        const position = document.getElementById(`edit-position-${id}`).value.trim();
        const shift = document.getElementById(`edit-shift-${id}`).value;
        const baseSalary = Number(document.getElementById(`edit-salary-${id}`).value) || 0;

        if (!name) { alert('Tên không được để trống!'); return; }
        
        showLoading();
        db.collection('employees').doc(id).update({
            name: name,
            position: position,
            shift: shift,
            baseSalary: baseSalary,
        })
        .then(() => {
            delete isEditingEmployee[id];
            alert(`Đã cập nhật thông tin nhân viên ${name}.`);
            hideLoading();
        })
        .catch(err => {
            console.error(err);
            hideLoading();
            alert('Lỗi cập nhật nhân viên');
        });
    }

    // Populate Attendance Table 
    function populateAttendanceTable(){
        attendanceTableBody.innerHTML='';
        const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : new Date('1970-01-01'); start.setHours(0,0,0);
        const end = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : new Date('3000-01-01'); end.setHours(23,59,59);
        const selectedEmployeeId = exportEmployee.value||'all'; // Đổi tên biến
        const selectedPosition = exportPosition.value||'all'; // Lấy giá trị chức vụ
        
        const filtered = attendance.filter(r=>{ 
            const d = new Date(r.date); 
            const emp = employees.find(x=>x.id===r.employeeId) || {}; // NEW: Tìm thông tin nhân viên
            
            const matchEmp = selectedEmployeeId==='all' || r.employeeId===selectedEmployeeId; 
            const matchPos = selectedPosition==='all' || (emp.position||'').trim() === selectedPosition; // NEW: Lọc theo chức vụ
            
            return d>=start && d<=end && matchEmp && matchPos; // Áp dụng cả hai bộ lọc
        });
        
        if (filtered.length === 0) {
            attendanceTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Không tìm thấy dữ liệu chấm công nào trong kỳ này.</td></tr>';
            return;
        }

        filtered.forEach(r=>{
            const emp = employees.find(x=>x.id===r.employeeId) || {};
            const finalShiftKey = r.shiftChosen || emp.shift || 'shift2'; 
            const empShift = shifts[finalShiftKey];
            const isEditing = isEditingAttendance[r.id];
            
            let checkIn = r.checkIn || '---';
            let checkOut = r.checkOut || '---';
            let note = r.lateReason ? `Xin phép: ${r.lateReason}` : '';
            let status = '';

            let hoursText = '0 giờ 0 phút';
            let finalCheckOut = r.checkOut;

            const tr = document.createElement('tr');
            tr.id = `att-row-${r.id}`;

            if (isEditing) {
                tr.innerHTML = `
                    <td>${new Date(r.date).toLocaleDateString('vi-VN')}</td>
                    <td>${emp.name||r.employeeName||'Unknown'}</td>
                    <td>${empShift?.name||'N/A'}</td>
                    <td><input type="time" step="1" class="form-control form-control-sm" id="edit-checkin-${r.id}" value="${r.checkIn || ''}"></td>
                    <td><input type="time" step="1" class="form-control form-control-sm" id="edit-checkout-${r.id}" value="${r.checkOut || ''}"></td>
                    <td>...</td>
                    <td>...</td>
                    <td><input type="text" class="form-control form-control-sm" id="edit-note-${r.id}" value="${r.lateReason || ''}"></td>
                    <td class="d-flex gap-1">
                        <button class="btn btn-sm btn-success btn-save-att" data-id="${r.id}"><i class="fas fa-save"></i></button>
                        <button class="btn btn-sm btn-secondary btn-cancel-att" data-id="${r.id}"><i class="fas fa-times"></i></button>
                    </td>
                `;
                attendanceTableBody.appendChild(tr); // Add the row to the table
                return; // Skip the rest of the loop for this row
            }

            if(r.checkIn){
                let inDT = new Date(`${r.date}T${r.checkIn}`);
                let outDT = null;

                // QUY TẮC QUÊN CHẤM RA: Nếu không có checkOut, đặt 23:00 và ghi chú quên chấm
                if (!r.checkOut) {
                    finalCheckOut = '23:00:00'; // Gán giá trị mặc định cho hiển thị
                    outDT = new Date(`${r.date}T${finalCheckOut}`);
                    note += ` / <span class="red-text">Quên chấm ra (23:00)</span>`;
                } else {
                    outDT = new Date(`${r.date}T${finalCheckOut}`);
                }

                if(outDT <= inDT) outDT.setDate(outDT.getDate() + 1);

                const diff = Math.max(0, outDT - inDT);
                const hrs = Math.floor(diff/3600000);
                const mins = Math.round((diff%3600000)/60000);
                hoursText = `${hrs} giờ ${mins} phút`;

                // --- LOGIC TRẠNG THÁI VỚI GRACE PERIOD 5 PHÚT ---
                const shiftStart = new Date(`${r.date}T${empShift.start}`);
                const isEarlyOrOnTime = inDT.getTime() <= shiftStart.getTime();
                const isAfterGracePeriod = inDT.getTime() > (shiftStart.getTime() + GRACE_PERIOD_MS);
                
                if (r.edited) {
                    status = 'Sửa công (Phạt 20k)';
                } else if (!r.checkOut) {
                    status = 'Quên chấm ra (Phạt 20k)';
                } else if (isEarlyOrOnTime) {
                    status = 'Đúng giờ';
                } else if (!isAfterGracePeriod) { 
                    status = 'Đúng giờ (Grace period)'; 
                } else if (isAfterGracePeriod) {
                    if (r.isLate) {
                        status = 'Đi muộn (Phạt 10k)'; 
                    } else if (r.lateReason) {
                        status = 'Đi muộn (Xin phép)'; 
                    } else {
                        status = 'Đi muộn (Lỗi dữ liệu củ)';
                    }
                } else {
                    status = 'Lỗi trạng thái'; 
                }
                // --- KẾT THÚC LOGIC TRẠNG THÁI ---
            } else {
                status = 'Vắng mặt';
            }

            const isHoliday = settings.holidays && settings.holidays.indexOf(r.date) >= 0;
            if (isHoliday) status += ' / Ngày lễ';

            tr.innerHTML = `<td>${new Date(r.date).toLocaleDateString('vi-VN')}</td>
                            <td>${emp.name||r.employeeName||'Unknown'}</td>
                            <td>${empShift?.name||'N/A'}</td>
                            <td>${checkIn}</td>
                            <td>${finalCheckOut}</td>
                            <td>${hoursText}</td>
                            <td>${status}</td>
                            <td>${note}</td>
                            <td class="d-flex gap-1">
                                <button class="btn btn-sm btn-info btn-edit-att" data-id="${r.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger btn-delete-att" data-id="${r.id}"><i class="fas fa-trash"></i></button>
                            </td>`;
            attendanceTableBody.appendChild(tr);
        });

        // Gán sự kiện cho các nút Sửa/Xóa mới
        document.querySelectorAll('.btn-edit-att').forEach(btn => btn.addEventListener('click', editAttendance));
        document.querySelectorAll('.btn-delete-att').forEach(btn => btn.addEventListener('click', deleteAttendance));
        document.querySelectorAll('.btn-save-att').forEach(btn => btn.addEventListener('click', saveAttendance));
        document.querySelectorAll('.btn-cancel-att').forEach(btn => btn.addEventListener('click', cancelEditAttendance));
    }

    // --- CHỨC NĂNG MỚI: SỬA/XÓA CHẤM CÔNG ---
    function deleteAttendance(event) {
        if (!isAdmin) { alert('Bạn cần quyền admin'); return; }
        const id = event.currentTarget.getAttribute('data-id');
        if (confirm('Bạn có chắc chắn muốn xóa lượt chấm công này không? Hành động này không thể hoàn tác.')) {
            showLoading();
            db.collection('attendance').doc(id).delete()
                .then(() => {
                    hideLoading();
                    alert('Đã xóa lượt chấm công.');
                    // Không cần gọi lại loadAttendance() vì onSnapshot sẽ tự động cập nhật
                })
                .catch(err => {
                    hideLoading();
                    console.error("Lỗi xóa chấm công: ", err);
                    alert('Đã xảy ra lỗi khi xóa.');
                });
        }
    }

    function editAttendance(event) {
        if (!isAdmin) { alert('Bạn cần quyền admin'); return; }
        const id = event.currentTarget.getAttribute('data-id');
        isEditingAttendance = { [id]: true }; // Chỉ cho phép sửa một dòng tại một thời điểm
        populateAttendanceTable();
    }

    function cancelEditAttendance(event) {
        const id = event.currentTarget.getAttribute('data-id');
        delete isEditingAttendance[id];
        populateAttendanceTable();
    }

    function saveAttendance(event) {
        if (!isAdmin) { alert('Bạn cần quyền admin'); return; }
        const id = event.currentTarget.getAttribute('data-id');
        const newCheckIn = document.getElementById(`edit-checkin-${id}`).value || null;
        const newCheckOut = document.getElementById(`edit-checkout-${id}`).value || null;
        const newNote = document.getElementById(`edit-note-${id}`).value.trim() || null;

        showLoading();
        db.collection('attendance').doc(id).update({ checkIn: newCheckIn, checkOut: newCheckOut, lateReason: newNote, edited: true })
            .then(() => {
                delete isEditingAttendance[id];
                hideLoading();
                alert('Đã cập nhật lượt chấm công.');
            })
            .catch(err => { hideLoading(); console.error(err); alert('Lỗi cập nhật.'); });
    }

    // Add employee with auto username and default password (giữ nguyên)
    function addEmployee(){ 
        if(!isAdmin){ alert('Cần quyền admin'); return; } 
        const name = document.getElementById('employeeName').value.trim(); 
        if(!name){ alert('Nhập tên'); return; } 
        const position = document.getElementById('employeePosition').value.trim(); 
        const baseSalary = Number(document.getElementById('employeeBaseSalary').value) || 0; 
        const shift = document.getElementById('employeeShift').value;
        const username = toUsername(name);
        const defaultPassword = 'thaithae';
        showLoading(); 
        db.collection('employees').add({ name, position, baseSalary, shift, username, password: defaultPassword, createdAt: firebase.firestore.FieldValue.serverTimestamp() })
        .then(()=>{ 
            document.getElementById('employeeName').value=''; document.getElementById('employeePosition').value=''; document.getElementById('employeeBaseSalary').value=''; 
            alert(`Đã thêm ${name} (username: ${username}, mật khẩu: ${defaultPassword})`); 
            hideLoading(); 
        })
        .catch(err=>{ console.error(err); hideLoading(); alert('Lỗi thêm nhân viên'); }); 
    }

    // Admin verify (giữ nguyên)
    function verifyAdmin(){ 
        const code = document.getElementById('adminCode').value; 
        if(code==='thaithae2025@'){ 
            isAdmin=true; 
            adminVerificationArea.style.display = 'none'; 
            adminFeatures.classList.remove('d-none'); 
            personalAttendancePanel.style.display = 'none';
            adminDashboardPanel.style.display = 'block';
            populateAttendanceTable(); 
            alert('Đã xác thực admin'); 
        } else alert('Mã admin không đúng'); 
    }
    
    // Admin Toggle (giữ nguyên)
    document.getElementById('adminToggle').addEventListener('click', () => {
        const isCurrentlyAdmin = adminDashboardPanel.style.display === 'block';
        if (isCurrentlyAdmin) {
            adminDashboardPanel.style.display = 'none';
            personalAttendancePanel.style.display = 'none';
            isAdmin = false;
        } else {
            adminDashboardPanel.style.display = 'block';
            personalAttendancePanel.style.display = 'none';
        }
    });

    // Clear attendance (giữ nguyên)
    function clearAttendance(){ 
        if(!isAdmin){ alert('Cần admin'); return; } 
        if(!confirm('Xóa toàn bộ dữ liệu chấm công?')) return; 
        showLoading(); 
        db.collection('attendance').get().then(snap=>{ const batch = db.batch(); snap.forEach(doc=> batch.delete(doc.ref)); return batch.commit(); })
        .then(()=>{ hideLoading(); alert('Đã xóa'); }).catch(err=>{ console.error(err); hideLoading(); alert('Lỗi xóa'); }); 
    }

    // Force logout all (giữ nguyên)
    function forceLogoutAll(){ 
        if(!isAdmin) { alert('Cần admin'); return; } 
        db.collection('meta').doc('session').set({forceLogoutAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true})
        .then(()=> alert('Đã ép all logout')).catch(e=>alert('Lỗi')); 
    }

    // Load/Save Settings (giữ nguyên logic V9)
    function loadSettings(){ 
        db.collection('meta').doc('payroll').get().then(doc=>{ 
            if(doc.exists){ 
                settings = {...settings, ...doc.data()}; 
                document.getElementById('holidayList').value = settings.holidays.join('\n'); 
                document.getElementById('wagePerHour').value = settings.wagePerHour||''; 
                document.getElementById('defaultBonus').value = settings.defaultBonus||''; 
                document.getElementById('defaultPenalty').value = settings.defaultPenalty||''; 
                document.getElementById('editPenalty').value = settings.editPenalty||'20000'; 
                document.getElementById('latePenalty').value = settings.latePenalty||'10000'; 
                document.getElementById('forgotOutPenalty').value = settings.forgotOutPenalty||'20000'; 
                document.getElementById('wifiIpAddress').value = settings.wifiIpAddress || '';
                renderHolidays();
            } 
        }); 
    }
    
    function renderHolidays(){
        const holidayText = settings.holidays.length > 0 ? settings.holidays.map(h => new Date(h).toLocaleDateString('vi-VN')).join(', ') : 'Chưa có ngày lễ nào.';
        document.getElementById('currentHolidays').textContent = `Ngày lễ đã lưu: ${holidayText}`;
    }

    function saveSettings(){ 
        if(!isAdmin){ alert('Cần admin'); return; } 
        settings.wagePerHour = Number(document.getElementById('wagePerHour').value)||0; 
        settings.defaultBonus = Number(document.getElementById('defaultBonus').value)||0; 
        settings.defaultPenalty = Number(document.getElementById('defaultPenalty').value)||0; 
        settings.editPenalty = Number(document.getElementById('editPenalty').value)||20000; 
        settings.latePenalty = Number(document.getElementById('latePenalty').value)||10000; 
        settings.forgotOutPenalty = Number(document.getElementById('forgotOutPenalty').value)||20000; 
        settings.wifiIpAddress = document.getElementById('wifiIpAddress').value.trim();
        
        const holidayInput = document.getElementById('holidayList').value;
        // Chấp nhận cách nhau bằng dấu phẩy, khoảng trắng, hoặc xuống dòng
        settings.holidays = holidayInput.split(/[\n,]/).map(s=>s.trim()).filter(Boolean); 

        db.collection('meta').doc('payroll').set(settings).then(()=>{ 
            renderHolidays();
            alert('Đã lưu cài đặt'); 
        }); 
    }

    // Login flow (cập nhật để hiển thị lịch sử cá nhân)
    async function login(){ 
        const username = toUsername(document.getElementById('loginUsername').value.trim()); 
        const password = document.getElementById('loginPassword').value || ''; 
        if(!username){ document.getElementById('loginMessage').innerHTML = '<div class="alert alert-warning">Nhập username</div>'; return; }
        const emp = employees.find(e=> (e.username||'')===username );
        if(!emp){ document.getElementById('loginMessage').innerHTML = '<div class="alert alert-danger">Không tìm thấy nhân viên</div>'; return; }
        if((emp.password||'thaithae') !== password){ document.getElementById('loginMessage').innerHTML = '<div class="alert alert-danger">Mật khẩu sai</div>'; return; }
        const expiresAt = Date.now() + SESSION_DURATION_MS;
        localStorage.setItem(SESSION_KEY, JSON.stringify({ employeeId: emp.id, username: emp.username, expiresAt, loginAt: Date.now() }));
        applyLoggedIn(emp);
    }
    function loginById(){ 
        const id = document.getElementById('loginUsername').value.trim(); 
        if(!id){ document.getElementById('loginMessage').innerHTML = '<div class="alert alert-warning">Nhập ID</div>'; return; } 
        const emp = employees.find(e=> e.id===id); 
        if(!emp){ document.getElementById('loginMessage').innerHTML = '<div class="alert alert-danger">Không tìm thấy ID</div>'; return; } 
        const expiresAt = Date.now() + SESSION_DURATION_MS; 
        localStorage.setItem(SESSION_KEY, JSON.stringify({ employeeId: emp.id, username: emp.username, expiresAt, loginAt: Date.now() })); 
        applyLoggedIn(emp);
    }

    function applyLoggedIn(emp){ 
        isAdmin = false;
        loggedInUser = emp;
        adminDashboardPanel.style.display = 'none'; 
        personalAttendancePanel.style.display = 'block';
        
        loginArea.style.display='none'; 
        clockingArea.classList.remove('d-none'); 
        document.getElementById('loggedName').textContent = emp.name; 
        document.getElementById('loggedPosition').textContent = emp.position||''; 
        document.getElementById('loggedShift').textContent = shifts[emp.shift]?.name || 'Không xác định';

        // Populate and select default shift
        shiftSelect.innerHTML = '<option value="">--- VUI LÒNG CHỌN CA LÀM ---</option>'; 
        for(const key in shifts){
            const option = document.createElement('option');
            option.value = key;
            option.textContent = `${shifts[key].name} (${shifts[key].start.substring(0,5)} - ${shifts[key].end.substring(0,5)})`;
            if(emp.shift === key) {
                option.setAttribute('selected', 'selected');
            }
            shiftSelect.appendChild(option);
        }

        document.getElementById('loginMessage').innerHTML = '<div class="alert alert-success">Đăng nhập thành công</div>'; 
        
        // Gọi các chức năng mới
        loadPersonalAttendance(emp.id);
        checkWeeklyLateNotes(emp.id);
    }

    function tryRestoreSession(){ 
        const s = localStorage.getItem(SESSION_KEY); 
        if(!s) return false; 
        try{ 
            const obj = JSON.parse(s); 
            if(Date.now() > obj.expiresAt) { localStorage.removeItem(SESSION_KEY); return false; } 
            const emp = employees.find(e=> e.id===obj.employeeId); 
            if(emp){ applyLoggedIn(emp); return true; } 
        } catch(e){ console.error(e); } 
        return false; 
    }

    // Logout (giữ nguyên)
    function logout(){ 
        const s = localStorage.getItem(SESSION_KEY); 
        if(!s) { location.reload(); return; } 
        const obj = JSON.parse(s);
        db.collection('meta').doc('session').get().then(doc=>{ 
            const forceAt = doc.exists && doc.data().forceLogoutAt ? doc.data().forceLogoutAt.toMillis() : 0; 
            if(forceAt && forceAt > (obj.loginAt||0)){ 
                localStorage.removeItem(SESSION_KEY); 
                location.reload(); 
                return; 
            }
            if(Date.now() < obj.expiresAt){ 
                alert('Phiên đăng nhập còn hiệu lực trong 4 ngày, không thể thoát. Liên hệ minhtan để ép đăng xuất.'); 
                return; 
            }
            localStorage.removeItem(SESSION_KEY); 
            location.reload(); 
        }).catch(e=>{ console.error(e); alert('Lỗi kiểm tra phiên'); }); 
    }

    // Check-in (LUẬT GRACE PERIOD 5 PHÚT và CẬP NHẬT GIỚI HẠN GHI CHÚ)
    async function checkIn(){ 
        if (!loggedInUser) {
            alert('Bạn chưa đăng nhập'); 
            return;
        }
        
        const emp = loggedInUser;
        const selectedShiftKey = shiftSelect.value;
        if (!selectedShiftKey) {
            alert('Vui lòng chọn ca làm việc của bạn hôm nay.');
            return;
        }

        // KIỂM TRA IP WIFI
        if (!(await isConnectedToAuthorizedWifi())) {
            return;
        }

        const shift = shifts[selectedShiftKey];
        const now = new Date(); 
        const dateStr = now.toISOString().split('T')[0]; 
        let timeStr = now.toLocaleTimeString('vi-VN',{hour12:false});
        
        let isLate = false;
        let finalTimeStr = timeStr; 

        const lateReasonText = document.getElementById('lateReason').value.trim();

        if(shift){ 
            const shiftStart = new Date(`${dateStr}T${shift.start}`);
            
            // 1. Chấm công đúng giờ (trước hoặc tại giờ bắt đầu ca)
            if(now.getTime() <= shiftStart.getTime()) { 
                finalTimeStr = shift.start; // Ghi nhận giờ vào là giờ bắt đầu ca
            } 
            // 2. Chấm công muộn SAU thời gian Grace Period (sau 5 phút) -> Bị phạt
            else if (now.getTime() > shiftStart.getTime() + GRACE_PERIOD_MS) {
                isLate = true; 
            }
            // 3. Chấm công trong Grace Period (từ 1 giây đến 5 phút) -> Vẫn ghi nhận giờ thực, nhưng isLate = false.
        }

        showLoading(); 
        const q = await db.collection('attendance').where('employeeId','==',emp.id).where('date','==',dateStr).get(); 
        if(!q.empty){ hideLoading(); alert('Bạn đã chấm công vào hôm nay'); return; }

        await db.collection('attendance').add({ 
            employeeId: emp.id, employeeName: emp.name, date: dateStr, 
            checkIn: finalTimeStr, checkOut: null, 
            shiftChosen: selectedShiftKey, 
            edited: false, 
            lateReason: lateReasonText, 
            // isLate chỉ TRUE nếu chấm công muộn (isLate = true) VÀ không có lý do xin phép
            isLate: isLate && !lateReasonText, 
            timestamp: firebase.firestore.FieldValue.serverTimestamp() 
        }); 
        hideLoading(); 
        
        let alertMessage = `Đã chấm công vào lúc ${finalTimeStr}. Ca làm đã chọn: ${shift.name}.`;
        
        const shiftStart = new Date(`${dateStr}T${shift.start}`);
        const isPastGrace = now.getTime() > (shiftStart.getTime() + GRACE_PERIOD_MS);
        const isWithinGrace = now.getTime() > shiftStart.getTime() && !isPastGrace;

        if (isPastGrace && isLate) {
            alertMessage += ' Bạn đã đi muộn (ngoài 5 phút Grace Period) và sẽ bị phạt.';
        } else if (isPastGrace && lateReasonText) {
            alertMessage += ' Bạn đã đi muộn nhưng có ghi chú xin phép.';
        } else if (isWithinGrace) {
            alertMessage += ' Bạn đã chấm công trong thời gian Grace Period (<= 5 phút) và được tính là Đúng giờ.';
        } else {
             alertMessage += ' Bạn đã chấm công Đúng giờ.';
        }

        alert(alertMessage);
        document.getElementById('lateReason').value = '';
        checkWeeklyLateNotes(emp.id); // Cập nhật lại trạng thái ghi chú
    }

    // Check-out (giữ nguyên)
    async function checkOut(){ 
        if (!loggedInUser) {
            alert('Bạn chưa đăng nhập');
            return;
        }

        // KIỂM TRA IP WIFI
        if (!(await isConnectedToAuthorizedWifi())) {
            return;
        }
        
        const emp = loggedInUser;
        const now = new Date(); const dateStr = now.toISOString().split('T')[0]; let timeStr = now.toLocaleTimeString('vi-VN',{hour12:false});
        showLoading(); 
        const q = await db.collection('attendance').where('employeeId','==',emp.id).where('date','==',dateStr).get(); 
        if(q.empty){ hideLoading(); alert('Bạn chưa chấm công vào hôm nay'); return; }
        const doc = q.docs[0]; const data = doc.data(); 
        if(data.checkOut){ hideLoading(); alert('Bạn đã chấm công ra rồi'); return; }
        await db.collection('attendance').doc(doc.id).update({ checkOut: timeStr, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
        hideLoading(); alert(`Đã chấm công ra lúc ${timeStr}`);
    }

    // Payroll computation (LUẬT PHẠT QUÊN CHẤM RA)
    function computePayroll(){ 
        printPayrollBtn.classList.add('d-none'); 
        
        const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : new Date('1970-01-01'); start.setHours(0,0,0);
        const end = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : new Date('3000-01-01'); end.setHours(23,59,59);
        const selectedEmployeeId = document.getElementById('exportEmployee').value||'all'; // Đổi tên biến
        const selectedPosition = document.getElementById('exportPosition').value||'all'; // Lấy giá trị chức vụ

        const holidays = settings.holidays||[];
        const filtered = attendance.filter(r=>{ 
            const d = new Date(r.date); 
            const emp = employees.find(x=>x.id===r.employeeId) || {}; // NEW: Tìm thông tin nhân viên
            
            const matchEmp = selectedEmployeeId==='all' || r.employeeId===selectedEmployeeId; 
            const matchPos = selectedPosition==='all' || (emp.position||'').trim() === selectedPosition; // NEW: Lọc theo chức vụ

            return d>=start && d<=end && matchEmp && matchPos; // Áp dụng cả hai bộ lọc
        });
        if(filtered.length===0){ alert('Không có dữ liệu để tính lương'); return; }

        const byEmp = {};
        for(const id in employees) { 
            const emp = employees[id];
            const matchEmp = selectedEmployeeId === 'all' || selectedEmployeeId === emp.id;
            const matchPos = selectedPosition === 'all' || (emp.position||'').trim() === selectedPosition; // NEW: Match position

            if (matchEmp && matchPos) { // Chỉ tính lương cho nhân viên thỏa mãn cả hai điều kiện lọc
                byEmp[emp.id] = { emp, records: [] };
            }
        }
        
        filtered.forEach(r=>{
            const emp = employees.find(e=>e.id===r.employeeId) || {name:r.employeeName||'Unknown', baseSalary:0, shift:r.shift||''};
            if(!byEmp[r.employeeId]) byEmp[r.employeeId] = { emp, records: [] };
            byEmp[r.employeeId].records.push(r);
        });

        payrollResults = {};
        for(const empId in byEmp){
            const {emp, records} = byEmp[empId];
            const wagePerHour = settings.wagePerHour || emp.baseSalary || 0;
            
            // --- START: NEW LOGIC FOR EDITABLE PAYROLL (Mục 3 & 7) ---
            let finalBonus = settings.defaultBonus||0;
            let finalEditPenalty = 0; // Calculated base for first run
            
            // Check if the editable input fields exist from a previous calculation/display
            const bonusInput = document.getElementById(`payroll-bonus-${empId}`);
            const penaltyInput = document.getElementById(`payroll-edit-penalty-${empId}`); // Mục 7
            
            if (bonusInput && penaltyInput) {
                // Read manually input values if elements exist
                finalBonus = Number(bonusInput.value) || 0;
                finalEditPenalty = Number(penaltyInput.value) || 0; // Use manual input for Mục 7
            }
            // ---  LOGIC FOR EDITABLE PAYROLL ---

            let totalDays=0; let totalWorkedMinutes=0; let totalOvertimeMinutes=0; 
            let totalForgotOut = 0; let totalEdited = 0; 
            let totalLate = 0; 
            let totalWage = 0; let holidayDetails=[];

            records.forEach(r=>{
                if(!r.checkIn){ return; }
                const currentShiftKey = r.shiftChosen || emp.shift || 'shift2'; 
                const currentShift = shifts[currentShiftKey];

                let inDT = new Date(`${r.date}T${r.checkIn}`);
                let finalCheckOut = r.checkOut || '23:00:00'; 
                let outDT = new Date(`${r.date}T${finalCheckOut}`);

                if(outDT <= inDT) outDT.setDate(outDT.getDate()+1);
                const diffMs = Math.max(0, outDT - inDT);
                const workedMins = Math.round(diffMs/60000);

                const isHoliday = holidays.indexOf(r.date) >= 0;
                let wageForThisDay = (wagePerHour / 60) * workedMins;
                
                if(isHoliday) {
                    let extraHolidayWage = wageForThisDay; 
                    wageForThisDay += extraHolidayWage; 
                    holidayDetails.push({date: r.date, minutes: workedMins, amount: Math.round(extraHolidayWage)});
                }
                totalWage += wageForThisDay;
                totalWorkedMinutes += workedMins;
                totalDays += 1;

                if (!r.checkOut) totalForgotOut += 1; // TÍCH LŨY PHẠT QUÊN CHẤM RA
                if (r.edited) totalEdited += 1;
                if (r.isLate) totalLate += 1; // TÍCH LŨY PHẠT ĐI MUỘN

                if (currentShift && workedMins > currentShift.minutes) {
                    totalOvertimeMinutes += (workedMins - currentShift.minutes);
                }
            });

            // Calculate penalties based on counts and settings
            const totalLatePenalties = totalLate * settings.latePenalty;
            const totalForgotOutPenalties = totalForgotOut * settings.forgotOutPenalty;
            
            // Item 4+5+6 (Statutory Penalties)
            const totalStatutoryPenalty = (settings.defaultPenalty || 0) + totalLatePenalties + totalForgotOutPenalties; 

            // Item 7 (Manual/Calculated Edit Penalty)
            if (!bonusInput) { // Only calculate based on edited count if this is the first run (no input field exists)
                finalEditPenalty = totalEdited * settings.editPenalty;
            }

            const totalExtraHolidayWage = holidayDetails.reduce((sum, h) => sum + h.amount, 0);

            // FINAL NET CALCULATION: Use finalBonus and finalEditPenalty (Mục 7)
            const net = totalWage + finalBonus - totalStatutoryPenalty - finalEditPenalty;

            const hrs = Math.floor(totalWorkedMinutes/60);
            const mins = Math.round(totalWorkedMinutes%60);
            const workedHoursText = `${hrs} giờ ${mins} phút`;

            const otHrs = Math.floor(totalOvertimeMinutes/60);
            const otMins = Math.round(totalOvertimeMinutes%60);
            const overtimeHoursText = `${otHrs} giờ ${otMins} phút`;

            payrollResults[empId] = {
                emp, totalDays, workedHoursText, overtimeHoursText,
                totalWage: Math.round(totalWage - totalExtraHolidayWage), 
                baseWage: Math.round(totalWage),
                bonus: finalBonus, // Use FINAL bonus value (manual or default)
                penalty: Math.round(totalStatutoryPenalty), // Item 4+5+6
                editPenalty: Math.round(finalEditPenalty), // Item 7 (Manual or calculated)
                latePenalties: Math.round(totalLatePenalties), 
                forgotOutPenalties: Math.round(totalForgotOutPenalties),
                totalExtraHolidayWage: Math.round(totalExtraHolidayWage),
                net: Math.round(net),
                holidayDetails, totalEdited, totalLate, totalForgotOut
            };
        }
        displayPayrollResults();
        printPayrollBtn.classList.remove('d-none');
    }
    
    // Display Payroll Result (Cập nhật để thêm ô nhập liệu)
    function displayPayrollResults(){ 
        if(Object.keys(payrollResults).length === 0) {
            payrollResultArea.style.display='none';
            alert('Không có kết quả tính lương.');
            return;
        }

        payrollResultArea.style.display='block';
        payrollResult.innerHTML = '';

        for(const empId in payrollResults){
            const r = payrollResults[empId];
            const emp = r.emp;
            const baseWageForTotalHours = r.baseWage - r.totalExtraHolidayWage; 

            let html = `<div class="card mb-3 p-3 border-left-success">
                <h6 class="text-primary">${emp.name} (${emp.position||''})</h6>
                <table class="table table-sm table-borderless small">
                    <tr><th>Tổng ngày công:</th><td>${r.totalDays} ngày</td></tr>
                    <tr><th>Tổng giờ làm:</th><td>${r.workedHoursText}</td></tr>
                    <tr><th>Tổng giờ làm thêm:</th><td>${r.overtimeHoursText}</td></tr>
                    <tr><th>Số lần sửa công:</th><td>${r.totalEdited} lần</td></tr>
                    <tr><th>Số lần đi muộn (bị phạt):</th><td>${r.totalLate} lần</td></tr>
                    <tr><th>Số lần quên chấm ra:</th><td>${r.totalForgotOut} lần</td></tr>
                </table>

                <h6 class="text-success mt-2">Chi tiết Lương</h6>
                <table class="table table-sm table-striped small">
                    <tr><th>1. Tổng lương (theo giờ, chưa x2 ngày lễ):</th><td class="text-end">${formatVND(baseWageForTotalHours)}</td></tr>
                    <tr><th>2. Lương ngày lễ được cộng thêm:</th><td class="text-end text-success">+ ${formatVND(r.totalExtraHolidayWage)}</td></tr>
                    <tr><th>3. Thưởng (Tự điền):</th> <td class="text-end text-success">
                            + <input type="number" class="form-control form-control-sm text-end d-inline w-50" 
                                id="payroll-bonus-${empId}" value="${r.bonus}">
                        </td>
                    </tr>
                    <tr><td colspan="2"><hr class="my-1"></td></tr>
                    <tr><th>Tổng thu nhập (1+2+3):</th><td class="text-end fw-bold">${formatVND(baseWageForTotalHours + r.totalExtraHolidayWage + r.bonus)}</td></tr>
                    <tr><td colspan="2"><hr class="my-1"></td></tr>
                    <tr><th>4. Phạt chung (Admin):</th><td class="text-end red-text">- ${formatVND(settings.defaultPenalty||0)}</td></tr>
                    <tr><th>5. Phạt đi muộn (${r.totalLate} lần):</th><td class="text-end red-text">- ${formatVND(r.latePenalties)}</td></tr>
                    <tr><th>6. Phạt quên chấm ra (${r.totalForgotOut} lần):</th><td class="text-end red-text">- ${formatVND(r.forgotOutPenalties)}</td></tr>
                    <tr><th>7. Phạt (Tự điền):</th> <td class="text-end red-text">
                            - <input type="number" class="form-control form-control-sm text-end d-inline w-50" 
                                id="payroll-edit-penalty-${empId}" value="${r.editPenalty}">
                        </td>
                    </tr>
                    <tr><th>Tổng Khấu trừ (4+5+6+7):</th><td class="text-end red-text fw-bold">- ${formatVND(r.penalty + r.editPenalty)}</td></tr>
                    <tr class="summary-row"><th>TỔNG THỰC NHẬN:</th><td class="text-end text-primary fs-5">${formatVND(r.net)}</td></tr>
                </table>
            </div>`;
            payrollResult.innerHTML += html;
        }
    }

    // Export to Excel (attendance) 
    function exportToExcel(){ 
        const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : new Date('1970-01-01'); start.setHours(0,0,0); 
        const end = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : new Date('3000-01-01'); end.setHours(23,59,59); 
        const selectedEmployeeId = document.getElementById('exportEmployee').value||'all';
        const selectedPosition = document.getElementById('exportPosition').value||'all'; // Lấy giá trị chức vụ

        const filtered = attendance.filter(r=>{ 
            const d = new Date(r.date); 
            const emp = employees.find(x=>x.id===r.employeeId) || {}; //  Tìm thông tin nhân viên
            
            const matchEmp = selectedEmployeeId==='all' || r.employeeId===selectedEmployeeId; 
            const matchPos = selectedPosition==='all' || (emp.position||'').trim() === selectedPosition; //  Lọc theo chức vụ

            return d>=start && d<=end && matchEmp && matchPos; // Áp dụng cả hai bộ lọc
        });
        if(filtered.length===0){ alert('Không có dữ liệu'); return; }
        
        const data = filtered.map(r=>{ 
            const emp = employees.find(e=> e.id===r.employeeId)||{}; 
            const finalShiftKey = r.shiftChosen || emp.shift || 'shift2'; 
            const empShift = shifts[finalShiftKey];

            let working='0 giờ 0 phút'; let minutes=0; 
            let finalCheckOut = r.checkOut || '23:00:00';
            let status = '';

            if(r.checkIn){ 
                let inDT=new Date(`${r.date}T${r.checkIn}`); 
                let outDT=new Date(`${r.date}T${finalCheckOut}`); 
                if(outDT<=inDT) outDT.setDate(outDT.getDate()+1); 
                const diff=outDT-inDT; const hrs=Math.floor(diff/3600000); const mins=Math.round((diff%3600000)/60000); 
                working=`${hrs} giờ ${mins} phút`; minutes = hrs*60 + mins; 

                const isHoliday = settings.holidays && settings.holidays.indexOf(r.date)>=0; 
                
                // --- LOGIC TRẠNG THÁI VỚI GRACE PERIOD 5 PHÚT KHI EXPORT ---
                const shiftStart = new Date(`${r.date}T${empShift.start}`);
                const isEarlyOrOnTime = inDT.getTime() <= shiftStart.getTime();
                const isAfterGracePeriod = inDT.getTime() > (shiftStart.getTime() + GRACE_PERIOD_MS);
                
                if (r.edited) {
                    status = 'Sửa công (Phạt)';
                } else if (!r.checkOut) {
                    status = 'Quên chấm ra (Phạt)';
                } else if (isEarlyOrOnTime) {
                    status = 'Đúng giờ';
                } else if (!isAfterGracePeriod) { 
                    status = 'Đúng giờ (Grace period)'; 
                } else if (isAfterGracePeriod) {
                    if (r.isLate) {
                        status = 'Đi muộn (Phạt)'; 
                    } else if (r.lateReason) {
                        status = 'Đi muộn (Xin phép)'; 
                    } else {
                        status = 'Đi muộn (Lỗi dữ liệu củ)';
                    }
                } else {
                    status = 'Lỗi trạng thái';
                }
                // --- KẾT THÚC LOGIC TRẠNG THÁI EXPORT ---

                if (isHoliday) status += ' / Ngày lễ';

            } else { status = 'Vắng mặt'; }

            const wagePerHour = settings.wagePerHour || emp.baseSalary || 0; 
            const multiplier = settings.holidays && settings.holidays.indexOf(r.date)>=0 ? 2 : 1;
            const amount = (minutes/60) * wagePerHour * multiplier;

            return { 
                'Ngày': r.date, 'Nhân viên': emp.name||r.employeeName||'Unknown', 'Chức vụ': emp.position||'', 
                'Ca': empShift?.name||'N/A', 'Giờ vào': r.checkIn||'---', 'Giờ ra (TT)': finalCheckOut, 
                'Thời gian làm việc': working, 'Trạng thái': status, 
                'Ghi chú/Xin phép': r.lateReason||'',
                'Lương (Tạm tính)': Math.round(amount) 
            } 
        });
        const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Du lieu Cham Cong'); 
        const filename = `Bao_cao_${document.getElementById('startDate').value||'all'}_den_${document.getElementById('endDate').value||'all'}.xlsx`; 
        XLSX.writeFile(wb, filename);
    }

    // Print/Export Payroll (Cập nhật nhãn)
    function generatePayslipHTML(results){ 
        payslipContainer.innerHTML = '';
        if(Object.keys(results).length === 0) return;

        for(const empId in results){
            const r = results[empId];
            const emp = r.emp;
            let holidayDetailText = r.holidayDetails.map(h=>`<li>Ngày ${h.date}: ${h.minutes/60} giờ (Cộng thêm: ${formatVND(h.amount)})</li>`).join('');
            
            const baseWageForTotalHours = r.baseWage - r.totalExtraHolidayWage; 

            let html = `<div class="payslip mb-5">
                <h4>PHIẾU LƯƠNG NHÂN VIÊN THAI THAE</h4>
                <h5>Từ ngày ${document.getElementById('startDate').value} đến ${document.getElementById('endDate').value}</h5>
                <p><strong>Nhân viên:</strong> ${emp.name} | <strong>Chức vụ:</strong> ${emp.position||'N/A'} | <strong>Lương cơ bản/giờ:</strong> ${formatVND(settings.wagePerHour || emp.baseSalary || 0)}</p>

                <table class="table table-bordered">
                    <thead><tr><th colspan="2" class="text-center bg-light">THÔNG TIN CHẤM CÔNG</th></tr></thead>
                    <tbody>
                        <tr><td>**Ngày công:**</td><td class="text-end">${r.totalDays} ngày</td></tr>
                        <tr><td>**Tổng giờ làm:**</td><td class="text-end">${r.workedHoursText}</td></tr>
                        <tr><td>**Tổng giờ làm thêm:**</td><td class="text-end">${r.overtimeHoursText}</td></tr>
                        <tr><td>**Lần sửa công:**</td><td class="text-end">${r.totalEdited} lần</td></tr>
                        <tr><td>**Lần quên chấm ra:**</td><td class="text-end">${r.totalForgotOut} lần</td></tr>
                    </tbody>
                </table>

                <table class="table table-bordered">
                    <thead><tr><th colspan="2" class="text-center bg-light">CHI TIẾT TÍNH LƯƠNG</th></tr></thead>
                    <tbody>
                        <tr><th>1. TỔNG LƯƠNG (theo giờ, chưa x2 ngày lễ):</th><td class="text-end">${formatVND(baseWageForTotalHours)}</td></tr>
                        <tr><th>2. LƯƠNG NGÀY LỄ (Cộng thêm 100%):</th><td class="text-end text-success">+ ${formatVND(r.totalExtraHolidayWage)}</td></tr>
                        <tr><th>3. THƯỞNG (Tự điền):</th><td class="text-end text-success">+ ${formatVND(r.bonus)}</td></tr>
                        
                        <tr><td colspan="2"><hr class="my-1"></td></tr>
                        <tr><th>Tổng thu nhập:</th><td class="text-end fw-bold">${formatVND(baseWageForTotalHours + r.bonus + r.totalExtraHolidayWage)}</td></tr>
                        <tr><td colspan="2"><hr class="my-1"></td></tr>

                        <tr><th>4. PHẠT CHUNG (Admin):</th><td class="text-end red-text">- ${formatVND(settings.defaultPenalty||0)}</td></tr>
                        <tr><th>5. PHẠT ĐI MUỘN (${r.totalLate} lần):</th><td class="text-end red-text">- ${formatVND(r.latePenalties)}</td></tr>
                        <tr><th>6. PHẠT QUÊN CHẤM RA (${r.totalForgotOut} lần):</th><td class="text-end red-text">- ${formatVND(r.forgotOutPenalties)}</td></tr>
                        <tr><th>7. PHẠT (Tự điền):</th><td class="text-end red-text">- ${formatVND(r.editPenalty)}</td></tr> <tr><th>TỔNG KHẤU TRỪ:</th><td class="text-end red-text fw-bold">- ${formatVND(r.penalty + r.editPenalty)}</td></tr>
                        
                        <tr class="summary-row"><th>TỔNG THỰC NHẬN:</th><td class="text-end text-primary fs-5"><strong>${formatVND(r.net)}</strong></td></tr>
                    </tbody>
                </table>
                
                <p class="small text-muted"><strong>Chi tiết Ngày lễ được nhân đôi:</strong></p>
                <ul class="small text-muted">${holidayDetailText || 'Không có ngày lễ trong kỳ này.'}</ul>
            </div>`;
            payslipContainer.innerHTML += html;
        }
        const modal = new bootstrap.Modal(document.getElementById('printExportModal'));
        modal.show();
    }

    // THAY THẾ: Chức năng tải phiếu lương dưới dạng file ZIP chứa ảnh PNG
    async function downloadPayslipsAsZip() {
        const payslips = document.querySelectorAll('.payslip');
        if (payslips.length === 0) {
            alert('Không có phiếu lương để tải.');
            return;
        }

        const zip = new JSZip();
        const downloadBtn = document.getElementById('downloadPayslipsZipBtn');
        const originalBtnText = downloadBtn.innerHTML;
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...`;

        try {
            // SỬA LỖI: Dùng vòng lặp for...of để duyệt qua NodeList một cách an toàn và hiện đại.
            let i = 0;
            for (const slip of payslips) {
                const empName = slip.querySelector('p strong').textContent.split('|')[0].trim().replace('Nhân viên:', '').trim();
                
                // Cập nhật tiến trình trên nút
                downloadBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang chụp ảnh ${++i}/${payslips.length}...`;

                const canvas = await html2canvas(slip, { scale: 2 }); // Tăng chất lượng ảnh
                const pngData = canvas.toDataURL('image/png').split(',')[1];
                
                // Thêm ảnh vào file ZIP
                zip.file(`${i}_${empName}.png`, pngData, { base64: true });
            }

            downloadBtn.innerHTML = `<i class="fas fa-file-archive"></i> Đang nén ZIP...`;
            const content = await zip.generateAsync({ type: 'blob' });

            const startDate = document.getElementById('startDate').value.replace(/-/g, '');
            const endDate = document.getElementById('endDate').value.replace(/-/g, '');
            const filename = `ngay${startDate}den${endDate}.zip`;

            saveAs(content, filename); // Sử dụng hàm trợ giúp để tải file
        } catch (error) {
            console.error('Lỗi khi tạo file ZIP:', error);
            alert('Đã xảy ra lỗi trong quá trình tạo file ZIP. Vui lòng thử lại.');
        } finally {
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = originalBtnText;
        }
    }

    // Export Payroll Excel (Cập nhật nhãn)
    function exportPayrollExcel(){ 
        if(Object.keys(payrollResults).length === 0) { alert('Chưa có dữ liệu tính lương'); return; }

        const wb = XLSX.utils.book_new();

        const summaryData = Object.values(payrollResults).map(r => {
            const baseWageForTotalHours = r.baseWage - r.totalExtraHolidayWage;
            return {
                'Mã NV': r.emp.id, 'Tên NV': r.emp.name, 'Chức vụ': r.emp.position || '', 'Ngày công': r.totalDays,
                'Giờ làm': r.workedHoursText, 'Giờ làm thêm': r.overtimeHoursText, 'Lần sửa công': r.totalEdited,
                'Lương Cơ bản/giờ': settings.wagePerHour || r.emp.baseSalary || 0,
                'Tổng lương (chưa x2 ngày lễ)': baseWageForTotalHours, 'Lương ngày lễ cộng thêm': r.totalExtraHolidayWage,
                'Thưởng (Tự điền)': r.bonus, 'Phạt chung': settings.defaultPenalty || 0, // Cập nhật nhãn
                'Phạt đi muộn': r.latePenalties, 
                'Phạt quên chấm ra': r.forgotOutPenalties, 
                'Phạt (Tự điền)': r.editPenalty, // Cập nhật nhãn
                'TỔNG THỰC NHẬN (VND)': r.net
            }
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryData), 'Tong Hop Luong');

        Object.values(payrollResults).forEach(r => {
            const baseWageForTotalHours = r.baseWage - r.totalExtraHolidayWage;
            const detailData = [
                { Key: 'Nhân viên', Value: r.emp.name }, { Key: 'Chức vụ', Value: r.emp.position || 'N/A' },
                { Key: 'Từ ngày', Value: document.getElementById('startDate').value }, { Key: 'Đến ngày', Value: document.getElementById('endDate').value },
                { Key: '--------------------', Value: '--------------------' },
                { Key: 'Tổng ngày công', Value: r.totalDays }, { Key: 'Tổng giờ làm', Value: r.workedHoursText },
                { Key: 'Tổng giờ làm thêm', Value: r.overtimeHoursText }, { Key: 'Số lần sửa công', Value: r.totalEdited },
                { Key: 'Số lần quên chấm ra', Value: r.totalForgotOut },
                { Key: 'Lương cơ bản/giờ', Value: formatVND(settings.wagePerHour || r.emp.baseSalary || 0) },
                { Key: '--------------------', Value: '--------------------' },
                { Key: 'TỔNG LƯƠNG (theo giờ, chưa x2 ngày lễ)', Value: formatVND(baseWageForTotalHours) },
                { Key: 'LƯƠNG NGÀY LỄ CỘNG THÊM', Value: formatVND(r.totalExtraHolidayWage) }, { Key: 'THƯỞNG (Tự điền)', Value: formatVND(r.bonus) }, // Cập nhật nhãn
                { Key: '--------------------', Value: '--------------------' },
                { Key: 'PHẠT CHUNG', Value: formatVND(settings.defaultPenalty || 0) }, 
                { Key: 'PHẠT ĐI MUỘN', Value: formatVND(r.latePenalties) }, 
                { Key: 'PHẠT QUÊN CHẤM RA', Value: formatVND(r.forgotOutPenalties) }, 
                { Key: 'PHẠT (Tự điền)', Value: formatVND(r.editPenalty) }, // Cập nhật nhãn
                { Key: '--------------------', Value: '--------------------' },
                { Key: 'TỔNG THỰC NHẬN', Value: formatVND(r.net) }
            ];

            const wsDetail = XLSX.utils.json_to_sheet(detailData, { header: ['Key', 'Value'] });
            XLSX.utils.book_append_sheet(wb, wsDetail, r.emp.name.substring(0, 30));
        });

        const filename = `Bang_luong_chi_tiet_${document.getElementById('startDate').value||'all'}_den_${document.getElementById('endDate').value||'all'}.xlsx`;
        XLSX.writeFile(wb, filename);
    }

    // Hàm trợ giúp để tải file (thay thế cho FileSaver.js)
    function saveAs(blob, filename) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
        // Initial state
        adminDashboardPanel.style.display = 'none'; 
        personalAttendancePanel.style.display = 'none';
        
        // Event listeners
        document.getElementById('verifyAdmin').addEventListener('click', verifyAdmin);
        document.getElementById('addEmployee').addEventListener('click', addEmployee);
        document.getElementById('clearDataBtn').addEventListener('click', clearAttendance);
        document.getElementById('forceLogoutAll').addEventListener('click', forceLogoutAll);
        document.getElementById('saveSettings').addEventListener('click', saveSettings);
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('loginByIdBtn').addEventListener('click', loginById);
        document.getElementById('checkInBtn').addEventListener('click', checkIn);
        document.getElementById('checkOutBtn').addEventListener('click', checkOut);

        // THÊM MỚI: Cho phép đăng nhập bằng phím Enter
        function handleEnterLogin(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('loginBtn').click();
            }
        }
        document.getElementById('loginUsername').addEventListener('keyup', handleEnterLogin);
        document.getElementById('loginPassword').addEventListener('keyup', handleEnterLogin);
        document.getElementById('adminCode').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') { event.preventDefault(); document.getElementById('verifyAdmin').click(); }
        });

        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        document.getElementById('submitLateRequestBtn').addEventListener('click', () => {
            const reason = document.getElementById('lateReason').value.trim();
            if (!reason) {
                alert('Vui lòng nhập lý do xin phép đi muộn vào ô ghi chú.');
                return;
            }
            alert('Đã ghi nhận yêu cầu của bạn. Vui lòng bấm nút "Vào" để chấm công. Lý do sẽ được lưu lại cùng với lần chấm công này.');
        });
        
        document.getElementById('applyFilterBtn').addEventListener('click', populateAttendanceTable);
        document.getElementById('exportBtn').addEventListener('click', exportToExcel);
        document.getElementById('computePayrollBtn').addEventListener('click', computePayroll);
        document.getElementById('printPayrollBtn').addEventListener('click', () => generatePayslipHTML(payrollResults));
        document.getElementById('downloadPayslipsZipBtn').addEventListener('click', downloadPayslipsAsZip);
        document.getElementById('exportPayslipExcelBtn').addEventListener('click', exportPayrollExcel);

        document.getElementById('startDate').valueAsDate = new Date(); 
        document.getElementById('endDate').valueAsDate = new Date();

        db.collection('meta').doc('session').onSnapshot(doc=>{
            if(doc.exists && doc.data().forceLogoutAt){
                const s = localStorage.getItem(SESSION_KEY);
                if(s){
                    const obj = JSON.parse(s);
                    if(obj && doc.data().forceLogoutAt.toMillis() > (obj.loginAt||0)){
                        localStorage.removeItem(SESSION_KEY);
                        location.reload();
                    }
                }
            }
        });

        loadSettings();
        loadEmployees();
        loadAttendance();
        setTimeout(()=>{ tryRestoreSession(); }, 800);


        // THÊM MỚI: Khởi tạo hiệu ứng nền 3D
        try {
            VANTA.FOG({
                el: "#vanta-bg",
                mouseControls: true,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                highlightColor: 0xe1a4ff, // Màu highlight (hồng tím sáng)
                midtoneColor: 0x8955ff,   // Màu trung gian (tím)
                lowlightColor: 0x2d004d,   // Màu tối (tím đậm)
                baseColor: 0x1a1839,      // Màu nền (xanh đen)
                speed: 1.20
            })
        } catch (e) {
            console.error("Lỗi khởi tạo Vanta.js:", e);
            document.body.style.backgroundColor = '#e3e5e9'; // Fallback nếu lỗi
        }

        // SỬA LỖI: Khởi tạo ngôn ngữ sau khi các thành phần khác đã sẵn sàng
        const savedLang = localStorage.getItem('language') || 'vi';
        setLanguage(savedLang);
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
